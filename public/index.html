<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Viewer</title>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #1e1e1e;
            color: #fff;
        }
        
        .container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .image-container {
            position: relative;
            max-width: 800px;
            width: 100%;
        }
        
        .latest-image {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .image-controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }

        .loading-indicator {
            text-align: center;
            padding: 20px;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="container">
            <div class="image-container">
                <template v-if="outputImage">
                        <img 
                            :src="outputImage" 
                            class="latest-image"
                            @error="handleImageError"
                            :alt="outputPrompt || '新生成的图片'"
                        >
                        <div class="image-controls">
                            <el-button 
                                type="primary" 
                                size="small" 
                                @click="downloadImage"
                                circle
                            >
                                <i class="fas fa-download"></i>
                            </el-button>

                            <el-button
                                type="primary"
                                circle
                                @click="openInPhotoshop"
                                title="在Photoshop中打开"
                            >
                                <i class="fas fa-edit"></i>
                            </el-button>
                        </div>
                    </template>
                <template v-else>
                        <div class="loading-indicator">
                            <div class="loading-spinner"></div>
                        <div>等待接收图片...</div>
                        </div>
                    </template>
                </div>
            </div>
        </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    
    <script>
        const { createApp, ref } = Vue;
        
        createApp({
            data() {
                return {
                    outputImage: null,
                    outputPrompt: '',
                    ws: null,
                    imageLoadError: false
                }
            },
            methods: {
                connectWebSocket() {
                    this.ws = new WebSocket('ws://localhost:3001');
                    
                    this.ws.onmessage = async (event) => {
                        try {
                            const data = JSON.parse(event.data);
                            if (data.type === 'image') {
                                if (data.image) {
                                    this.outputImage = 'data:image/png;base64,' + data.image;
                                }
                                this.outputPrompt = data.prompt;
                            }
                        } catch (error) {
                            console.error('Error processing WebSocket message:', error);
                        }
                    };
                },
                
                handleImageError(e) {
                    console.error('图片加载失败:', e);
                    this.imageLoadError = true;
                },
                
                async downloadImage() {
                    if (!this.outputImage) return;
                    
                    try {
                        const response = await fetch(this.outputImage);
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `image-${Date.now()}.png`;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                        
                        this.$message({
                            message: '图片下载成功',
                            type: 'success',
                            duration: 2000
                        });
                    } catch (error) {
                        console.error('下载图片失败:', error);
                        this.$message.error('下载图片失败');
                    }
                },
                
                async openInPhotoshop() {
                    if (!this.outputImage) {
                            this.$message.warning('没有可用的图片');
                            return;
                        }

                    try {
                        const response = await axios.post('/api/open-in-photoshop', {
                            imageData: this.outputImage  // 直接发送当前显示的图片数据
                        });

                        if (response.data.success) {
                            this.$message.success('已经发送到Photoshop');
                        } else {
                            this.$message.error('发送到Photoshop失败');
                        }
                    } catch (error) {
                        console.error('发送到Photoshop失败:', error);
                        this.$message.error(error.response?.data?.error || '发送图片失败');
                    }
                }
            },
            mounted() {
                this.connectWebSocket();
            }
        }).use(ElementPlus).mount('#app')
    </script>
</body>
</html> 
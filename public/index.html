<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AUTOcmfy</title>
    <link rel="icon" type="image/x-icon" href="/image/logox.ico">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" href="//unpkg.com/element-plus/dist/index.css" />
    <script src="//unpkg.com/element-plus"></script>
    <link 
        rel="stylesheet" 
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    >
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        :root {
            --el-color-primary: #000000;
            --el-color-success: #67C23A;
            --el-color-warning: #E6A23C;
            --el-color-danger: #F56C6C;
            --el-color-info: #909399;
            --bg-dark: #1a1a1a;
            --bg-darker: #141414;
            --text-light: rgba(255, 255, 255, 0.95);
            --text-gray: rgba(255, 255, 255, 0.65);
            --border-dark: #333333;
            --input-bg: #242424;
            --hover-bg: #2a2a2a;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-light);
            padding: 0;
            margin: 0;
            overflow: hidden;
        }

        /* 修改容器基础样式 */
        .container {
            width: 100%;
            height: 100vh;
            display: flex;
            position: relative;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }

        /* 修改分屏模式样式 */
        .container.split-screen {
            display: flex;
            gap: 0;
            background: var(--bg-dark);
            padding: 0;
        }

        /* 修改 ComfyUI iframe 的基础样式 */
        .comfyui-frame {
            width: 0;
            height: 100vh;
            border: none;
            background: var(--bg-dark);
            opacity: 0;
            transform: translateX(-50%);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            flex-shrink: 0;
        }

        /* 分屏模式下的 iframe 样式 */
        .container.split-screen .comfyui-frame {
            width: 50%;
            opacity: 1;
            transform: translateX(0);
        }

        /* 修改主面板样式 */
        .main-panel {
            flex: 1;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: var(--bg-dark);
            position: relative;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* 分屏模式下主面板样式 */
        .container.split-screen .main-panel {
            width: 50%;
            flex: none;
        }

        /* 修改控制面板和历史面板在分屏模式下的样式 */
        .container.split-screen .control-panel,
        .container.split-screen .history-panel {
            display: none;
            pointer-events: none;
        }

        .control-panel {
            width: 400px;
            height: 100vh;
            background: var(--bg-dark);
            padding: 20px;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            transform-origin: left center;
        }

        .control-panel.hidden {
            transform: translateX(-100%);
            opacity: 0;
            width: 0;
            padding: 0;
            margin: 0;
            overflow: hidden;
            pointer-events: none;  /* 禁用交互 */
        }

        .latest-image-container {
            max-width: 100%;
            max-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .latest-image {
            max-width: 100%;
            max-height: calc(100vh - 40px);
            object-fit: contain;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .history-panel {
            width: 300px;
            height: 100vh;
            background: var(--bg-darker);
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            transform-origin: center;
            opacity: 1;
            width: 400px; /* 设置固定宽度 */
        }

        .history-panel.hidden {
            transform: translateX(100%);
            opacity: 0;
            width: 0;
            padding: 0;
            margin: 0;
            overflow: hidden;
        }

        .history-images-container {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .history-image-item {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;  /* 添加相对定位 */
        }

        .history-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .history-image:hover {
            transform: scale(1.02);
        }

        .history-image.selected {
            border: 2px solid var(--el-color-primary);
        }

        .panel-title {
            text-align: center;
            padding: 10px;
            font-weight: bold;
            color: #666;
            border-bottom: 1px solid #eee;
            margin-bottom: 10px;
        }

        .node-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .node-item {
            display: flex;
            align-items: center;
            padding: 8px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            background: #f8fafc;
        }

        .node-checkbox {
            margin-right: 10px;
        }

        .param-display {
            margin-top: 20px;
        }

        /* 修改参数卡片容器样式 */
        .selected-params {
            flex: 1;
            overflow-y: auto;
            padding-right: 10px;
            margin-right: -10px;
            padding-bottom: 100px; /* 为底部按钮留出空间 */
            height: 100%;
            position: relative;
        }
        
        /* 添加拖拽区域指示器 */
        .drop-zone {
            position: absolute;
            left: 0;
            right: 0;
            height: 20px;  /* 增加间隔区域的高度 */
            pointer-events: all;
            z-index: 1;
        }
        
        .drop-zone.active {
            background: rgba(var(--el-color-primary-rgb), 0.1);
        }
        
        /* 修改参数卡片样式 */
        .param-card {
            background: var(--bg-darker);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;  /* 减小卡片间距，为拖拽区域留空间 */
            position: relative;
            cursor: move;
            z-index: 2;  /* 确保卡片在拖拽区域之上 */
        }

        /* 添加拖拽区域指示器 */
        .param-card::before {
            content: '';
            position: absolute;
            top: -10px;  /* 扩展上方拖拽区域 */
            left: 0;
            right: 0;
            height: calc(100% + 20px);  /* 扩展整体高度 */
            z-index: -1;
        }

        /* 拖拽时的视觉效果 */
        .param-card.dragging {
            transform: scale(1.02);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            opacity: 0.9;
            /* 增加拖拽时的视觉反馈 */
            border: 2px dashed var(--el-color-primary);
            background: var(--bg-dark);
        }

        /* 拖拽目标区域的样式 */
        .param-card.drag-target {
            position: relative;
            margin-top: 20px;
            margin-bottom: 20px;
        }

        /* 拖拽放置区域指示器 */
        .drag-indicator {
            position: absolute;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--el-color-primary);
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
        }

        .drag-indicator.top {
            top: -12px;
        }

        .drag-indicator.bottom {
            bottom: -12px;
        }

        .param-card.drag-over-top .drag-indicator.top,
        .param-card.drag-over-bottom .drag-indicator.bottom {
            opacity: 1;
        }

        .param-card:hover {
            box-shadow: 0 0 0 1px rgba(255,255,255,0.2);
        }

        .param-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border-bottom: 1px solid var(--border-dark);
        }

        .param-value {
            font-family: monospace;
            color: var(--text-gray);
        }

        .param-type {
            font-size: 12px;
            padding: 2px 6px;
            background: #edf2f7;
            border-radius: 4px;
            color: #718096;
        }

        /* 修改按钮组样式 */
        .button-group {
            display: flex;
            flex-wrap: nowrap;
            gap: 10px;
            margin-bottom: 15px;
            flex-shrink: 0;
            align-items: center;
            min-width: 0;
        }

        button {
            padding: 8px 16px;
            background-color: var(--el-color-primary);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            white-space: nowrap;  /* 防止文字换行 */
            flex-shrink: 0;       /* 防止按钮缩小 */
        }

        button:hover {
            background-color: var(--el-color-primary-light-3);
        }

        .node-section {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .node-title {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e2e8f0;
        }

        .params-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .param-row {
            display: grid;
            grid-template-columns: 30px 150px 80px 1fr;
            align-items: center;
            padding: 8px;
            background: #f8fafc;
            border-radius: 6px;
            gap: 10px;
        }

        .param-checkbox {
            display: flex;
            align-items: center;
        }

        .param-name {
            font-weight: 500;
            color: #4a5568;
        }

        .param-type {
            font-size: 12px;
            padding: 2px 6px;
            background: #edf2f7;
            border-radius: 4px;
            color: #718096;
            text-align: center;
        }

        .param-edit {
            display: flex;
            align-items: center;
        }

        .param-input {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-dark);
            border-radius: 6px;
            font-family: monospace;
            transition: all 0.2s ease;
            background: var(--bg-darker);
            color: var(--text-light);
        }

        .param-input:focus {
            outline: none;
            border-color: var(--text-light);
        }

        .param-connection {
            color: #718096;
            font-size: 13px;
            font-family: monospace;
        }

        .search-section {
            flex-shrink: 0;
            margin-bottom: 15px;
        }

        .search-results {
            margin-top: 10px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            max-height: calc(100vh - 300px);
            overflow-y: auto;
            margin-bottom: 100px;
        }

        .param-item {
            padding: 8px 12px;
            border-bottom: 1px solid #e2e8f0;
        }

        .param-item:last-child {
            border-bottom: none;
        }

        .param-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        .param-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .param-type-badge {
            font-size: 12px;
            padding: 2px 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            color: var(--text-gray);
        }

        .drag-handle {
            color: #718096;
            margin-right: 8px;
            cursor: move;
        }

        .remove-btn {
            padding: 4px 8px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            color: var(--text-gray);
        }

        .remove-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .workflow-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-shrink: 0;
        }

        .workflow-select {
            flex: 1;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid var(--border-dark);
            transition: all 0.2s ease;
            background: var(--bg-darker);
            color: var(--text-light);
        }

        .workflow-select:focus {
            outline: none;
            border-color: var(--text-light);
            box-shadow: 0 0 0 1px #000;
        }

        .save-preset-btn {
            padding: 8px 16px;
            background: #4a5568;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            white-space: nowrap;
        }

        .save-preset-btn:hover {
            background: #2d3748;
        }

        .param-group {
            margin-bottom: 15px;
        }

        .param-group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #f7fafc;
            border-bottom: 1px solid #e2e8f0;
            font-weight: 500;
        }

        .select-all-btn {
            padding: 2px 8px;
            font-size: 12px;
            background: #4a5568;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .select-all-btn:hover {
            background: #2d3748;
        }

        .no-results {
            padding: 12px;
            text-align: center;
            color: #718096;
        }

        .param-name {
            font-weight: 500;
        }

        .image-upload-section {
            margin: 10px 0;
            padding: 12px;
            border: 1px dashed rgba(0,0,0,0.1);
            border-radius: 6px;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .image-upload-section.dragging {
            border-color: #4a5568;
            background-color: rgba(74, 85, 104, 0.05);
        }

        .upload-hint {
            color: #718096;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .upload-hint i {
            font-size: 18px;
            margin-bottom: 4px;
        }

        .upload-label {
            display: inline-block;
            padding: 4px 12px;
            background: #4a5568;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 14px;
        }

        .upload-label:hover {
            background: #2d3748;
        }

        .preview-image {
            max-width: 120px;
            max-height: 120px;
            margin-top: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        input[type="file"] {
            display: none;
        }

        .image-controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            opacity: 0;
            transition: opacity 0.3s ease;
            backdrop-filter: blur(8px);
        }

        .image-controls .el-button {
            width: 36px;
            height: 36px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            transition: all 0.3s ease;
        }

        .image-controls .el-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .image-controls .el-button i {
            font-size: 16px;
        }

        .output-image-container:hover .image-controls {
            opacity: 1;
        }

        .image-control-btn {
            padding: 8px;
            background: rgba(0, 0, 0, 0.7);
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s ease;
        }

        .image-control-btn:hover {
            background: rgba(0, 0, 0, 0.85);
        }

        .loading-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            color: #666;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 2px solid rgba(255,255,255,0.1);
            border-top-color: var(--text-light);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        }

        .selected-params {
            flex: 1;
            overflow-y: auto;
            padding-right: 10px;
            margin-right: -10px;
            /* 增加内边距以容纳拖拽区域 */
            padding-top: 10px;
            padding-bottom: 10px;
        }

        .param-card {
            background: var(--bg-darker);
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .param-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--border-dark);
        }

        .param-title {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .param-content {
            margin-top: 10px;
        }

        .param-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-family: monospace;
        }

        .param-connection {
            padding: 8px;
            background: #f8fafc;
            border-radius: 6px;
            color: #718096;
            font-family: monospace;
        }

        .control-panel {
            display: flex;
            flex-direction: column;
        }

        .workflow-selector {
            order: 1;
        }

        .button-group {
            order: 2;
        }

        .selected-params {
            order: 3;
            flex: 1;
            min-height: 0;
        }

        .search-section {
            order: 4;
        }

        /* 全局滚动条样式 */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-darker);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            transition: background 0.2s ease;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        ::-webkit-scrollbar-corner {
            background: var(--bg-darker);
        }
        
        /* 特定容器的滚动条样式 */
        .selected-params::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }
        
        .history-panel::-webkit-scrollbar-track {
            background: var(--bg-darker);
        }

        .seed-control {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .seed-toggle-btn {
            padding: 6px 10px;
            background: #409EFF;
            color: white;
            border: 1px solid var(--border-dark);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .seed-toggle-btn:hover {
            background: #66b1ff;
            color: white;
        }

        .seed-toggle-btn.active {
            background: #409EFF;
            color: white;
            border-color: #409EFF;
        }

        .param-input:disabled {
            background-color: #edf2f7;
            cursor: not-allowed;
        }

        /* 修改批量控制部分的样����� */
        .batch-control {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 1;  /* 允许缩小 */
            min-width: 0;    /* 允许容器缩小 */
        }

        .batch-input {
            width: 60px;
            padding: 6px;
            border: 1px solid var(--border-dark);
            border-radius: 4px;
            text-align: center;
            background: var(--bg-darker);
            color: var(--text-light);
        }

        .batch-label {
            color: var(--text-gray);
            margin-left: 4px;
        }

        .param-textarea {
            resize: none;
            overflow: hidden;
            min-height: 32px;
            line-height: 1.5;
            padding: 6px 10px;
            width: 100%;
            font-family: inherit;
        }

        .output-prompt {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 6px;
            max-width: 80%;
        }

        .saved-images-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            height: 100%;
            overflow-y: auto;
        }

        .saved-image-item {
            width: 100%;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .saved-image {
            width: 100%;
            height: auto;
            object-fit: contain;
        }

        .param-custom-name {
            width: 100%;
            padding: 6px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            font-family: monospace;
        }

        .param-name-container {
            flex: 1;
            min-width: 0;
        }

        .param-custom-name {
            width: 100%;
            padding: 2px 6px;
            border: 1px solid transparent;
            border-radius: 4px;
            font-size: inherit;
            background: transparent;
            color: inherit;
            font-family: inherit;
        }

        .param-custom-name:hover {
            border-color: #e2e8f0;
            background: #fff;
        }

        .param-custom-name:focus {
            border-color: #4a5568;
            background: #fff;
            outline: none;
        }

        .el-input-number {
            width: 100px;
        }

        .param-input, .search-input, .workflow-select, .batch-input {
            background: var(--input-bg);
            color: var(--text-light);
            border: 1px solid var(--border-dark);
            font-size: 14px;
            line-height: 1.5;
            transition: all 0.2s ease;
        }

        .param-input:hover, .search-input:hover, .workflow-select:hover, .batch-input:hover {
            background: var(--hover-bg);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .param-input:focus, .search-input:focus, .workflow-select:focus, .batch-input:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.5);
            background: var(--hover-bg);
        }

        .param-card {
            background: var(--bg-darker);
            border: 1px solid var(--border-dark);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .param-card:hover {
            border-color: rgba(255, 255, 255, 0.2);
            background: var(--hover-bg);
        }

        .param-type-badge {
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-gray);
            font-weight: 500;
        }

        .param-name {
            color: var(--text-light);
            font-weight: 500;
            letter-spacing: 0.3px;
        }

        .param-value {
            color: var(--text-gray);
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
            font-size: 13px;
        }

        .remove-btn {
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-gray);
            transition: all 0.2s ease;
        }

        .remove-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            color: var(--text-light);
        }

        .panel-title {
            color: var(--text-gray);
            font-weight: 600;
            font-size: 15px;
            letter-spacing: 0.5px;
        }

        .batch-label {
            color: var(--text-gray);
            font-size: 14px;
        }

        .el-input-number {
            --el-input-bg-color: var(--input-bg);
            --el-input-text-color: var(--text-light);
            --el-input-border-color: var(--border-dark);
            --el-input-hover-border-color: rgba(255, 255, 255, 0.2);
        }

        /* 调整复选框和标签的样式 */
        .param-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            border-radius: 4px;
            transition: background-color 0.2s;
            cursor: pointer;
        }

        .param-checkbox:hover {
            background: var(--hover-bg);
        }

        /* 自定义复选框样式 */
        .param-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            border: 2px solid var(--text-gray);
            border-radius: 4px;
            appearance: none;
            -webkit-appearance: none;
            cursor: pointer;
            position: relative;
            background: var(--input-bg);
            transition: all 0.2s;
        }

        .param-checkbox input[type="checkbox"]:checked {
            background: var(--el-color-primary);
            border-color: var(--el-color-primary);
        }

        .param-checkbox input[type="checkbox"]:checked::after {
            content: '✓';
            position: absolute;
            color: white;
            font-size: 14px;
            left: 3px;
            top: -1px;
        }

        .param-checkbox input[type="checkbox"]:hover {
            border-color: var(--text-light);
        }

        /* 调整搜索结果样式 */
        .search-results {
            background: var(--bg-darker);
            border: 1px solid var(--border-dark);
            border-radius: 6px;
            overflow: hidden;
            margin-top: 8px;
        }

        .param-item {
            padding: 4px 8px;
            border-bottom: 1px solid var(--border-dark);
            transition: background-color 0.2s;
        }

        .param-item:last-child {
            border-bottom: none;
        }

        .param-item:hover {
            background: var(--hover-bg);
        }

        .param-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .param-info .param-name {
            color: var(--text-light);
            font-weight: 500;
        }

        .param-info .param-type-badge {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-gray);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
        }

        /* 整无结果提示样式 */
        .no-results {
            padding: 12px;
            text-align: center;
            color: var(--text-gray);
            background: var(--bg-darker);
        }

        .workflow-selector {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }

        .workflow-select {
            flex: 1;
        }

        .save-preset-btn {
            white-space: nowrap;
            background: var(--bg-darker);
            border: 1px solid var(--border-dark);
            color: var(--text-light);
        }

        .save-preset-btn:hover {
            background: var(--hover-bg);
            border-color: var(--text-light);
        }

        .search-button-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
        }

        /* 在分屏模式或 F5 模式下的样式 */
        .container:not(.show-side-panels) .search-button-container {
            right: 20px !important; /* 使用 !important 确保优先级 */
            left: auto !important;  /* 确保不会移到左边 */
            position: fixed !important;
        }

        /* 当侧边栏隐藏时的样式 */
        .container.split-screen .search-button-container {
            right: 20px !important;
            left: auto !important;
            position: fixed !important;
        }

        .search-toggle-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: rgba(23, 23, 23, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-light);
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.2);
            -webkit-backdrop-filter: blur(10px);  /* 添加 Safari 支持 */
        }

        .search-toggle-btn:hover {
            background: rgba(32, 32, 32, 0.8);
            border-color: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }

        .search-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(3px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            -webkit-backdrop-filter: blur(3px);   /* 添加 Safari 支持 */
        }

        .search-popup {
            width: min(500px, calc(100% - 40px));
            background: rgba(23, 23, 23, 0.95);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .search-popup-header {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .popup-search-input {
            flex: 1;
            padding: 12px 16px;
            background: var(--input-bg);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: var(--text-light);
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .popup-search-input:hover {
            background: var(--hover-bg);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .popup-search-input:focus {
            outline: none;
            background: var(--hover-bg);
            border-color: rgba(255, 255, 255, 0.3);
            box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.1);
        }

        /* 修改关闭按钮的点击处理 */
        .close-search-btn {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: var(--text-light);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fade-enter-active,
        .fade-leave-active {
            transition: opacity 0.2s ease;
        }

        .fade-enter-from,
        .fade-leave-to {
            opacity: 0;
        }

        /* 修自定义名称输入框的式 */
        .param-name-input {
            width: 100%;
            padding: 6px 10px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            color: var(--text-light);
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .param-name-input:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .param-name-input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
        }

        /* 添加占位符文字的样式 */
        .param-name-input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        /* 确保参数卡片中的文字晰可见 */
        .param-card {
            /* ... 其他样式 ... */
            color: var(--text-light);
        }

        .param-header {
            /* ... 其他样式 ... */
            color: var(--text-light);
        }

        .param-name {
            color: var(--text-light);
            font-weight: 500;
        }

        .param-value {
            font-family: monospace;
            color: var(--text-gray);
        }

        /* 修改所有输入框的基础样式 */
        input[type="text"],
        input[type="number"],
        textarea {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-light);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            padding: 8px 12px;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        input[type="text"]:hover,
        input[type="number"]:hover,
        textarea:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.2);
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        textarea:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
            box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.1);
        }

        /* 修占位符文字颜色 */
        input::placeholder,
        textarea::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        /* 特别修改节点参数输入样式 */
        .param-input {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-light);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            padding: 8px 12px;
            width: 100%;
            font-family: monospace;
            transition: all 0.2s ease;
        }

        .param-input:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .param-input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
            box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.1);
        }

        /* 修改数字输入框的箭头样 */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            background: rgba(255, 255, 255, 0.1);
            opacity: 1;
            height: 20px;
            cursor: pointer;
        }

        /* 确保文本区域的样式一致 */
        textarea {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-light);
            border: 1px solid rgba(255, 255, 255, 0.1);
            resize: vertical;
            min-height: 80px;
        }

        /* 修改批控制部分的样式 */
        .batch-control {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* 修改 Element Plus 数字输入框样式 */
        .el-input-number {
            --el-input-bg-color: var(--input-bg);
            --el-input-text-color: var(--text-light);
            --el-input-border-color: var(--border-dark);
            --el-input-hover-border-color: rgba(255, 255, 255, 0.2);
        }

        .el-input-number:hover {
            --el-input-bg-color: rgba(255, 255, 255, 0.15) !important;
        }

        .el-input-number:focus-within {
            --el-input-bg-color: rgba(255, 255, 255, 0.2) !important;
        }

        /* 修改数字输入框的控制按钮样式 */
        .el-input-number__decrease,
        .el-input-number__increase {
            background-color: rgba(255, 255, 255, 0.1) !important;
            border-color: rgba(255, 255, 255, 0.1) !important;
            color: var(--text-light) !important;
        }

        .el-input-number__decrease:hover,
        .el-input-number__increase:hover {
            background-color: rgba(255, 255, 255, 0.2) !important;
            color: var(--text-light) !important;
        }

        /* 改输入框内数字的样式 */
        .el-input-number .el-input__inner {
            color: var(--text-light) !important;
            font-size: 14px !important;
            text-align: center !important;
        }

        .batch-label {
            color: var(--text-gray);
            font-size: 14px;
        }

        .custom-number-input {
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
            min-width: 0;     /* 允许容器缩小 */
            flex-shrink: 1;   /* 允许缩小 */
        }

        .number-btn {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 0;
            title="减少数量"  /* 添加第一个按钮的标题 */
        }

        .number-btn:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.2);
        }

        .number-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .number-input {
            width: 50px;
            height: 32px;
            border: none;
            background: transparent;
            color: var(--text-light);
            font-size: 14px;
            text-align: center;
            -moz-appearance: textfield;
            min-width: 40px;  /* 设置最小宽度 */
            width: 100%;      /* 填充容器 */
            -webkit-appearance: textfield;  /* 添加 Chrome 等浏览器支持 */
            placeholder="输入数量"  /* 添加输入框提示 */
        }

        .number-input::-webkit-outer-spin-button,
        .number-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .number-input:focus {
            outline: none;
        }

        /* 修改工作流选择器和保存预设按钮的样式 */
        .workflow-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .workflow-select {
            flex: 1;
            width: 100%;
        }

        /* 修改保存预设按钮样式 */
        .el-button {
            height: 40px !important;
            padding: 0 20px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            background: rgba(255, 255, 255, 0.1) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            color: var(--text-light) !important;
            font-size: 14px !important;
            transition: all 0.2s ease !important;
            white-space: nowrap !important;
        }

        .el-button:hover {
            background: rgba(255, 255, 255, 0.15) !important;
            border-color: rgba(255, 255, 255, 0.2) !important;
        }

        /* 确保 el-select 也使用相同的样式 */
        .el-select {
            --el-select-input-focus-border-color: rgba(255, 255, 255, 0.3) !important;
            width: 100% !important;
        }

        .el-select .el-input__wrapper {
            background: rgba(255, 255, 255, 0.1) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            box-shadow: none !important;
            width: 100% !important;
        }

        .el-select .el-input__wrapper:hover {
            background: rgba(255, 255, 255, 0.15) !important;
            border-color: rgba(255, 255, 255, 0.2) !important;
        }

        .el-select .el-input__wrapper.is-focus {
            background: rgba(255, 255, 255, 0.2) !important;
            border-color: rgba(255, 255, 255, 0.3) !important;
        }

        /* 修改下拉框的宽度 */
        .el-popper.is-pure {
            width: var(--el-select-width, auto) !important;
            min-width: var(--el-select-width, 200px) !important;
        }

        /* 确保选择框和下拉列表宽度一致 */
        .el-select__popper {
            width: 100% !important;
            min-width: unset !important;
        }

        .model-path {
            margin-bottom: 15px;
            padding: 10px;
            background: var(--bg-darker);
            border-radius: 6px;
            color: var(--text-light);
        }

        .error-message {
            color: var(--el-color-danger);
            padding: 20px;
            text-align: center;
        }

        .loading-message {
            color: var(--text-gray);
            padding: 20px;
            text-align: center;
        }

        /* 自定义 Element Plus 样式 */
        .el-dialog {
            background: var(--bg-dark) !important;
            border: 1px solid var(--border-dark);
        }

        .el-dialog__title {
            color: var(--text-light) !important;
        }

        .el-tabs {
            background: var(--bg-darker) !important;
            border: 1px solid var(--border-dark) !important;
        }

        .el-tabs__item {
            color: var(--text-gray) !important;
        }

        .el-tabs__item.is-active {
            color: var(--text-light) !important;
        }

        .el-table {
            background: var(--bg-darker) !important;
            color: var(--text-light) !important;
        }

        .el-table th {
            background: var(--bg-dark) !important;
            color: var(--text-light) !important;
        }

        .el-table tr {
            background: var(--bg-darker) !important;
        }

        .el-table td {
            color: var(--text-gray) !important;
        }

        .settings-btn {
            width: 32px !important;
            height: 32px !important;
            padding: 0 !important;
            font-size: 14px !important;
        }

        .settings-content {
            padding: 20px;
        }

        .setting-item {
            margin-bottom: 20px;
        }

        .setting-label {
            margin-bottom: 8px;
            color: var(--text-light);
            font-weight: 500;
        }

        .setting-hint {
            margin-top: 8px;
            color: var(--text-gray);
            font-size: 12px;
        }

        /* 调整对话框样式 */
        .el-dialog {
            background: var(--bg-darker) !important;
            border: 1px solid var(--border-dark);
        }

        .el-dialog__header {
            padding: 20px !important;
            margin: 0 !important;
            border-bottom: 1px solid var(--border-dark);
        }

        .el-dialog__title {
            color: var(--text-light) !important;
            font-size: 16px !important;
            line-height: 1 !important;
        }

        .el-dialog__headerbtn {
            top: 20px !important;
            right: 20px !important;
        }

        .el-dialog__headerbtn .el-dialog__close {
            color: var(--text-gray) !important;
        }

        .el-dialog__body {
            padding: 20px !important;
            color: var(--text-light) !important;
        }

        /* 调整输入框样式 */
        .el-input__wrapper {
            background: var(--input-bg) !important;
            box-shadow: none !important;
        }

        .el-input__inner {
            color: var(--text-light) !important;
        }

        .el-input-group__append {
            background: var(--bg-dark) !important;
            border-color: var(--border-dark) !important;
        }

        .el-input-group__append .el-button {
            border: none !important;
            padding: 0 12px !important;
        }

        /* 拖拽时的视觉效果 */
        .param-card.dragging {
            transform: scale(1.02);  /* 略微放大 */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);  /* 添加阴影 */
            opacity: 0.9;
            border: 2px dashed var(--border-light);
        }

        /* 拖拽时的手柄样式 */
        .dragging .drag-handle {
            cursor: grabbing;
        }

        /* 拖拽目标位置的指示器 */
        .param-card::after {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--el-color-primary);
            opacity: 0;
            transition: opacity 0.2s;
        }

        .param-card.drag-over-top::after {
            top: -2px;
            opacity: 1;
        }

        .param-card.drag-over-bottom::after {
            bottom: -2px;
            opacity: 1;
        }

        /* 修改拖拽相关的样式 */
        .param-card {
            /* ... 其他样式 ... */
            position: relative;
            margin-bottom: 15px;
        }

        .param-card.dragging {
            opacity: 0.5;
            transform: scale(1.02);
        }

        .param-card.drag-over-top::before {
            content: '';
            position: absolute;
            top: -2px;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--el-color-primary);
        }

        .param-card.drag-over-bottom::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--el-color-primary);
        }

        /* 添加顶部控制栏样式 */
        .top-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        /* 修改执行按钮样式 */
        .execute-button {
            background-color: #409EFF !important;
            color: white !important;
            width: 100% !important;  /* 填充容器度 */
            max-width: 360px !important;  /* 最大宽度限制 */
            height: 45px !important;
            font-size: 16px !important;
            border-radius: 6px !important;
            box-shadow: 0 2px 12px 0 rgba(0,0,0,0.1);
            margin: 0 auto;
            display: block;
            transition: all 0.3s ease;  /* 添加过渡效果 */
        }

        /* 添悬停效果 */
        .execute-button:hover {
            background-color: #66b1ff !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 15px 0 rgba(0,0,0,0.15);
        }

        /* 添加点击效果 */
        .execute-button:active {
            background-color: #3a8ee6 !important;
            transform: translateY(1px);
            box-shadow: 0 2px 8px 0 rgba(0,0,0,0.1);
        }

        /* 添加媒体查询，在较窄屏幕上调整按钮大小 */
        @media screen and (max-width: 480px) {
            .execute-button {
                max-width: 280px !important;
                height: 40px !important;
                font-size: 14px !important;
            }
        }

        /* 添加底部执行按钮容器样式 */
        .execute-button-container {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: calc(100% - 40px);
            background: var(--bg-dark);
            padding: 10px 0;
            z-index: 100;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1); /* 添加阴影效果 */
        }

        /* Logo 容器样式 */
        .logo-container {
            padding: 16px;
            margin-bottom: 12px;
            text-align: center;
            background: var(--bg-darker);
            border-bottom: 1px solid var(--border-dark);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
        }
        
        /* Logo 图片样式 */
        .auto-logo {
            width: 50px;  /* 使用固定宽度 */
            height: 50px; /* 保持正方形 */
            opacity: 0.9;
            object-fit: contain;
            display: block;
            margin: 0 auto;
        }

        .auto-logo:hover {
            opacity: 1;
        }

        /* Logo 文字样式 */
        .logo-text {
            font-size: 18px;
            color: var(--text-gray);
            margin: 2px 0;
            white-space: pre-line;
            padding: 4px 0;
            font-weight: 500;
            line-height: 1.5;
            max-width: 90%;
            text-align: center;
            transition: color 0.3s ease;
        }

        .logo-text:last-child {
            margin-top: 4px;
            font-weight: 600;
        }

        /* 确保历史面板中的 logo 也使用相同大小 */
        .history-panel .logo-container {
            padding: 16px;
            margin-bottom: 6px;
        }

        .history-panel .auto-logo {
            width: 20px;
            height: 20px;
        }

        /* 添加下拉选择样式 */
        .el-select {
            width: 100%;
        }
        
        .el-select .el-input__inner {
            background-color: var(--input-bg);
            border-color: var(--border-dark);
            color: var(--text-light);
        }
        
        .el-select .el-input__inner:hover,
        .el-select .el-input__inner:focus {
            border-color: var(--el-color-primary);
        }
        
        .el-select-dropdown {
            background-color: var(--bg-darker);
            border-color: var(--border-dark);
        }
        
        .el-select-dropdown__item {
            color: var(--text-light);
        }
        
        .el-select-dropdown__item.hover,
        .el-select-dropdown__item:hover {
            background-color: rgba(64, 158, 255, 0.1) !important;
            color: var(--el-color-primary);
        }

        /* 改下拉选框样式 */
        select.param-input {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-dark);
            border-radius: 6px;
            background: var(--bg-darker);
            color: var(--text-light);
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 16px;
            padding-right: 32px;
        }
        
        select.param-input:hover {
            border-color: var(--text-light);
        }
        
        select.param-input:focus {
            outline: none;
            border-color: var(--el-color-primary);
        }
        
        /* 下拉选项样式 */
        select.param-input option {
            background: var(--bg-darker);
            color: var(--text-light);
            padding: 8px;
        }

        .param-slider-container {
            padding: 8px 0;
        }
        
        .slider-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .slider-label {
            color: var(--text-light);
            font-size: 14px;
        }
        
        .slider-value {
            color: var(--text-gray);
            font-size: 14px;
            font-family: monospace;
        }
        
        .custom-slider {
            --el-slider-main-bg-color: #409EFF !important;
            --el-slider-runway-bg-color: rgba(64, 158, 255, 0.2) !important;
        }
        
        .el-slider__button {
            border-color: #409EFF !important;
            background-color: #409EFF !important;
        }
        
        /* 添加滑块悬停效果 */
        .el-slider__button:hover {
            transform: scale(1.1);
        }
        
        /* 块激活状态 */
        .el-slider__button.hover,
        .el-slider__button:hover {
            box-shadow: 0 0 0 5px rgba(64, 158, 255, 0.2);
        }

        /* 现有的样式 */
        
        .mask-draw-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 36px;
            height: 36px;
            border-radius: 4px;
            background: #409EFF;
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .mask-draw-btn:hover {
            background: #66b1ff;
            transform: scale(1.05);
        }

        .mask-drawer-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .canvas-container {
            position: relative;
            width: 100%;
            height: 80vh;
            background: #1a1a1a;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .base-image {
            position: absolute;
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            object-fit: contain;
        }

        .mask-canvas {
            position: absolute;
            cursor: crosshair;
            background: transparent;
            pointer-events: all;
        }

        .drawing-controls {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 10px;
        }

        .brush-size-control {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* ... 其他样式 ... */
        .node-id {
            color: var(--text-light);
            font-weight: bold;
            margin-right: 8px;
            flex-shrink: 0;
            font-size: 14px;
            opacity: 0.9;
        }

        .param-name-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
        }

        .node-id {
            color: var(--text-light);
            font-weight: bold;
            margin-right: 8px;
            flex-shrink: 0;
            font-size: 14px;
            opacity: 0.9;
        }

        .param-custom-name {
            width: 100%;
            padding: 2px 6px;
            border: 1px solid transparent;
            border-radius: 4px;
            font-size: inherit;
            background: transparent;
            color: inherit;
            font-family: inherit;
            flex: 1;
            min-width: 0;
        }

        .param-custom-name:hover {
            border-color: var(--border-dark);
            background: var(--input-bg);
        }

        .param-custom-name:focus {
            border-color: var(--text-light);
            background: var(--input-bg);
            outline: none;
        }

        /* 种子控制样式 */
        .seed-control {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .seed-toggle-btn {
            padding: 6px 10px;
            background: #409EFF;
            color: white;
            border: 1px solid var(--border-dark);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .seed-toggle-btn:hover {
            background: #66b1ff;
            color: white;
        }

        .seed-toggle-btn.active {
            background: #409EFF;
            color: white;
            border-color: #409EFF;
        }

        .param-input:disabled {
            background-color: var(--bg-darker);
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* 修改遮罩绘制对话框的样式 */
        .mask-drawer-dialog {
            .el-dialog__body {
                padding: 0 !important;
            }
        }

        .author-info {
            color: var(--text-gray);
            font-size: 9px;
            opacity: 0.65;
        }

        .author-info i {
            font-style: italic;
        }

        .author-info {
            color: var(--text-gray);
            font-size: 9px;
            opacity: 0.65;
        }

        .author-link {
            font-style: italic;
            cursor: pointer;
            transition: opacity 0.2s ease;
        }

        .author-link:hover {
            opacity: 1;
            text-decoration: underline;
        }

        .control-panel.hidden,
        .history-panel.hidden {
            width: 0;
            opacity: 0;
            transform: translateX(-20px);
            overflow: hidden;
            padding: 0;
            margin: 0;
        }

        .history-panel.hidden {
            transform: translateX(20px);
        }

        .search-btn {
            width: 32px !important;
            height: 32px !important;
            padding: 0 !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            background: rgba(255, 255, 255, 0.1) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            color: var(--text-light) !important;
            font-size: 14px !important;
            title="搜索"  /* 添加搜索按钮标题 */
        }

        .search-btn:hover {
            background: rgba(255, 255, 255, 0.15) !important;
            border-color: rgba(255, 255, 255, 0.2) !important;
        }

        /* 分屏模式下主面板的动画 */
        .container.split-screen .main-panel {
            transform: translateX(0);
            width: 50%;
        }

        /* 添加图片容器在分屏模式下的样式 */
        .container.split-screen .latest-image-container {
            padding: 10px;  /* 减小内边距 */
        }

        .container.split-screen .latest-image {
            max-width: calc(50vw - 20px);  /* 调整最大宽度 */
            max-height: calc(100vh - 20px);
        }

        /* 修改 ComfyUI iframe 的样式 */
        .comfyui-frame {
            width: 50%;  /* 设置固定宽度 */
            height: 100vh;
            border: none;
            background: var(--bg-dark);
            opacity: 1;
            transform: translateX(0);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* 修改分屏模式下的 iframe 显示 */
        .container.split-screen .comfyui-frame {
            opacity: 1;
            transform: translateX(0);
        }

        /* ��分屏模式下隐藏 iframe */
        .comfyui-frame {
            opacity: 0;
            transform: translateX(-100%);
            width: 0;
        }

        .image-controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .latest-image-container:hover .image-controls {
            opacity: 1;
        }

        /* 调整树形选择的暗色主题样式 */
        .el-tree-select {
            --el-select-bg-color: var(--bg-darker);
            --el-tree-node-hover-bg-color: var(--hover-bg);
            --el-fill-color-blank: var(--bg-darker);
        }

        .el-select-dropdown__item {
            color: var(--text-light) !important;
        }

        .el-select-dropdown__item.hover,
        .el-select-dropdown__item:hover {
            background-color: var(--hover-bg) !important;
        }

        .logo-container {
            text-align: center;
            margin: 20px 0;
        }

        .auto-logo {
            max-width: 200px;
            height: auto;
        }

        .logo-text {
            color: #666;
            font-size: 12px;
            margin-top: 5px;
        }

        /* 修改工作流选择器样式 */
        .workflow-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-shrink: 0;
        }

        .workflow-select {
            flex: 1;
        }

        /* 自定义 Element Plus Select 组件样式 */
        .el-select {
            --el-select-border-color-hover: var(--border-dark);
            --el-select-input-focus-border-color: var(--text-light);
            width: 100%;
        }

        .el-select .el-input__wrapper {
            background-color: var(--input-bg);
            border-color: var(--border-dark);
            box-shadow: none !important;
        }

        .el-select .el-input__inner {
            color: var(--text-light);
            font-size: 14px;
            height: 40px;
            line-height: 40px;
        }

        /* 下拉菜单样式 */
        .el-select-dropdown {
            background-color: #2a2a2a;
            border: 1px solid var(--border-dark);
            border-radius: 8px;
            padding: 8px 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .el-select-dropdown__item {
            color: var(--text-light);
            height: 40px;
            line-height: 40px;
            padding: 0 16px;
            font-size: 14px;
        }

        .el-select-dropdown__item.hover, 
        .el-select-dropdown__item:hover {
            background-color: rgba(64, 158, 255, 0.1) !important;
            color: var(--el-color-primary);
        }

        .el-select-dropdown__item.selected {
            background-color: rgba(64, 158, 255, 0.2) !important;
            color: white;
            font-weight: 500;
        }

        /* 添加选中项的特殊样式 */
        .el-select-dropdown__item.selected::after {
            content: '✓';
            position: absolute;
            right: 16px;
            color: var(--el-color-primary-light-3);
        }

        /* 确保下拉菜单在其他元素之上 */
        .el-popper {
            z-index: 9999 !important;
        }

        /* 输入框激活状态样式 */
        .el-select .el-input.is-focus .el-input__wrapper {
            border-color: var(--el-color-primary) !important;
            box-shadow: 0 0 0 1px var(--el-color-primary) !important;
        }

        /* 保存预设按钮样式 */
        .save-preset-btn.el-button {
            background: var(--el-color-primary);
            border-color: var(--el-color-primary);
            color: white;
        }

        .save-preset-btn.el-button:hover {
            background: var(--el-color-primary-light-3);
            border-color: var(--el-color-primary-light-3);
        }

        /* 添加下拉箭头样式 */
        .el-select .el-input__suffix {
            color: var(--text-gray);
        }

        /* 下拉框禁用状态 */
        .el-select.is-disabled .el-input__wrapper {
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* 修改 Logo 文字大小 */
        .logo-text {
            font-size: 10px;  /* 减小文字大小 */
            color: var(--text-gray);
        }

        .workflow-select-btn {
            flex: 1;
            text-align: left;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .workflow-dialog {
            --grid-gap: 16px;
            --item-height: 80px;
        }

        .workflow-grid-container {
            width: 100%;
            height: 70vh;
            overflow-y: auto;
            padding: var(--grid-gap);
        }

        .workflow-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--grid-gap);
        }

        .workflow-item {
            height: var(--item-height);
            background: var(--bg-darker);
            border: 1px solid var(--border-dark);
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
        }

        .workflow-item:hover {
            background: var(--hover-bg);
            transform: translateY(-2px);
        }

        .workflow-item.active {
            border-color: var(--el-color-primary);
            background: var(--hover-bg);
        }

        .workflow-content {
            flex: 1;
            overflow: hidden;
        }

        .workflow-name {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-light);
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .workflow-path {
            font-size: 12px;
            color: var(--text-gray);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .workflow-actions {
            color: var(--text-gray);
            opacity: 0.5;
            transition: opacity 0.2s ease;
        }

        .workflow-item:hover .workflow-actions {
            opacity: 1;
        }

        .drag-handle {
            cursor: grab;
        }

        .workflow-item.dragging {
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="container" :class="{ 'split-screen': splitScreenMode }">
            <!-- ComfyUI iframe - 只在分屏模式显示 -->
            <iframe 
                class="comfyui-frame"
                src="http://127.0.0.1:8188"
                frameborder="0"
            ></iframe>

            <!-- 现有的面板 -->
            <div class="control-panel" :class="{ 'hidden': !showSidePanels }">
                <div class="workflow-selector">
                    <el-button 
                        @click="showWorkflowDialog = true"
                        class="workflow-select-btn"
                        size="large"
                        type="primary"
                    >
                        {{ currentWorkflowName || '选择工作流' }}
                    </el-button>
                    <el-button 
                        class="save-preset-btn" 
                        @click="savePreset"
                        type="primary"
                        size="large"
                    >
                        保存预设
                    </el-button>
                </div>

                <div class="button-group">
                    <div class="top-controls">
                        <div class="batch-control">
                            <div class="custom-number-input">
                                <button 
                                    class="number-btn" 
                                    @click="decrementCount" 
                                    :disabled="batchCount <= 1"
                                >
                                    <i class="fas fa-minus"></i>
                                </button>
                                <input 
                                    type="number" 
                                    v-model="batchCount" 
                                    min="1" 
                                    max="10"
                                    class="number-input"
                                >
                                <button 
                                    class="number-btn" 
                                    @click="incrementCount"
                                    :disabled="batchCount >= 10"
                                >
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                            <span class="batch-label">张</span>
                        </div>
                        <button @click="loadWorkflow" :disabled="loading">
                            {{ loading ? '加载中...' : '重新加载' }}
                        </button>
                        <!-- 添加搜索按钮 -->
                        <button @click="showSearch = true" class="search-btn">
                            <i class="fas fa-search"></i>
                        </button>
                        <el-button @click="showSettings = true" class="settings-btn">
                            <i class="fas fa-cog"></i>
                        </el-button>
                    </div>
                </div>

                <!-- 添加底部执行按钮 -->
                <div class="execute-button-container">
                    <button 
                        @click="executeWorkflow" 
                        :disabled="loading"
                        class="execute-button"
                    >
                        {{ loading ? '执行中...' : '执行工作流' }}
                    </button>
                </div>

                <!-- 添加选中参数显示区域 -->
                <div class="selected-params">
                    <!-- 添加第一个拖拽区域 -->
                    <div 
                        class="drop-zone"
                        @dragover.prevent="handleDropZoneDragOver($event, 0)"
                        @drop="handleDropZoneDrop($event, 0)"
                        :class="{ 'active': dragOverZoneIndex === 0 }"
                        style="top: 0;"
                    ></div>
                    
                    <template v-for="param in filteredParams" :key="param.id">
                        <div 
                            v-if="selectedParams[param.id]" 
                            class="param-card"
                            draggable="true"
                            @dragstart="handleDragStart($event, param.id)"
                            @dragover.prevent="handleParamDragOver($event, param.id)"
                            @dragenter.prevent
                            @drop="handleParamDrop($event, param.id)"
                            @dragend="handleParamDragEnd"
                            :class="{ 
                                'dragging': draggedParamId === param.id,
                                'drag-over-top': dragOverTop === param.id,
                                'drag-over-bottom': dragOverBottom === param.id
                            }"
                        >
                            <!-- 数卡片内容 -->
                            <div class="param-header">
                                <div class="param-title">
                                    <i class="fas fa-grip-vertical drag-handle"></i>
                                    <div class="param-name-container">
                                        <div class="param-name-wrapper">
                                            <span class="node-id">#{{ param.nodeId }}</span>
                                            <input
                                                type="text"
                                                v-model="paramCustomNames[param.id]"
                                                :placeholder="`${param.name}`"
                                                class="param-custom-name"
                                                @change="savePreset"
                                            >
                                        </div>
                                    </div>
                                </div>
                                <button class="remove-btn" @click="unselectParam(param.id)">×</button>
                            </div>
                            <div class="param-content">
                                <!-- 为 LoadImage 类型的节点或 ETN_LoadMaskBase64 节点添加图片上传功能 -->
                                <template v-if="(param.name === 'image' && workflow[param.nodeId]?.class_type === 'LoadImage') ||
                                                 (param.name === 'mask' && workflow[param.nodeId]?.class_type === 'ETN_LoadMaskBase64')">
                                    <div 
                                        class="image-upload-section"
                                        @dragover.prevent="handleDragOver"
                                        @dragleave.prevent="handleDragLeave"
                                        @drop.prevent="handleDrop($event, param.nodeId)"
                                        :class="{ 'dragging': isDragging }"
                                    >
                                        <label class="upload-label" :for="'upload-' + param.id">
                                            <i class="fas fa-upload"></i> 上传图片
                                        </label>
                                        <div class="upload-hint">
                                            <i class="fas fa-cloud-upload-alt"></i>
                                            <span>拖拽图片此处或点击上传</span>
                                        </div>
                                        <input 
                                            :id="'upload-' + param.id"
                                            type="file" 
                                            accept="image/*"
                                            @change="(e) => handleImageUpload(e, param.nodeId)"
                                        >
                                        <img 
                                            v-if="workflow[param.nodeId].preview" 
                                            :src="workflow[param.nodeId].preview" 
                                            class="preview-image"
                                            alt="览图"
                                        >
                                        <button 
                                            v-if="workflow[param.nodeId].preview && param.name === 'mask'"
                                            class="mask-draw-btn"
                                            @click="openMaskDrawer(param.nodeId)"
                                            title="绘制遮罩"
                                        >
                                            <i class="fas fa-paint-brush"></i>
                                        </button>
                                    </div>
                                </template>
                                <!-- 其他参数类型默认显示 -->
                                <template v-else>
                                    <template v-if="!Array.isArray(param.value)">
                                        <!-- 添加预处理器的特殊处理 -->
                                        <template v-if="isPreprocessorParameter(param.nodeId, param.name)">
                                            <select 
                                                v-model="workflow[param.nodeId].inputs[param.name]"
                                                class="param-input"
                                                @change="updateWorkflow"
                                            >
                                                <option 
                                                    v-for="preprocessor in preprocessors" 
                                                    :key="preprocessor"
                                                    :value="preprocessor"
                                                >
                                                    {{ preprocessor }}
                                                </option>
                                            </select>
                                        </template>
                                        <template v-else-if="isModelParameter(param.nodeId, param.name)">
                                            <el-select
                                                v-model="workflow[param.nodeId].inputs[param.name]"
                                                class="param-input"
                                                @change="handleCheckpointChange(param.nodeId, $event)"
                                                filterable
                                                placeholder="选择模型"
                                            >
                                                <el-option
                                                    v-for="model in getModelList(param.nodeId, param.name)"
                                                    :key="model.value"
                                                    :label="model.name"
                                                    :value="model.value"
                                                />
                                            </el-select>
                                        </template>
                                        <!-- 添加 scheduler 参数的特殊处理 -->
                                        <template v-else-if="param.name === 'scheduler'">
                                            <el-select
                                                v-model="workflow[param.nodeId].inputs[param.name]"
                                                class="param-input"
                                                @change="updateWorkflow"
                                                placeholder="选择调度器"
                                            >
                                                <el-option
                                                    v-for="scheduler in [
                                                        'normal',
                                                        'karras',
                                                        'exponential',
                                                        'sgm_uniform',
                                                        'simple',
                                                        'ddim_uniform',
                                                        'beta',
                                                        'linear_quadratic'
                                                    ]"
                                                    :key="scheduler"
                                                    :label="scheduler"
                                                    :value="scheduler"
                                                />
                                            </el-select>
                                        </template>
                                        <!-- 添加 sampler_name 参数的特殊处理 -->
                                        <template v-else-if="param.name === 'sampler_name'">
                                            <el-select
                                                v-model="workflow[param.nodeId].inputs[param.name]"
                                                class="param-input"
                                                @change="updateWorkflow"
                                                placeholder="选择采样器"
                                            >
                                                <el-option
                                                    v-for="sampler in samplers"
                                                    :key="sampler"
                                                    :label="sampler"
                                                    :value="sampler"
                                                />
                                            </el-select>
                                        </template>
                                        <template v-else>
                                            <!-- 如果是 seed 参数，添加随机/固定切换功能 -->
                                            <template v-if="param.name === 'seed'">
                                                <div class="seed-control">
                                                    <input
                                                        type="number"
                                                        v-model="workflow[param.nodeId].inputs[param.name]"
                                                        @change="updateWorkflow"
                                                        class="param-input"
                                                        :disabled="workflow[param.nodeId].seed_random"
                                                    >
                                                    <button 
                                                        class="seed-toggle-btn"
                                                        :class="{ 'active': workflow[param.nodeId].seed_random }"
                                                        @click="toggleSeedMode(param.nodeId)"
                                                        :title="workflow[param.nodeId].seed_random ? '当前为随机种子' : '为固定种子'"
                                                    >
                                                        <i :class="workflow[param.nodeId].seed_random ? 'fas fa-random' : 'fas fa-lock'"></i>
                                                    </button>
                                                </div>
                                            </template>
                                            <!-- 其他参数保持原样 -->
                                            <template v-else>
                                                <!-- 原有的参数输入逻辑 -->
                                                <template v-if="isSliderParameter(param.nodeId, param.name)">
                                                    <param-slider
                                                        v-model="workflow[param.nodeId].inputs[param.name]"
                                                        :label="param.name"
                                                        v-bind="getSliderConfig(param.name)"
                                                        @change="updateWorkflow"
                                                    />
                                                </template>
                                                <template v-else>
                                                    <textarea
                                                        v-if="typeof param.value === 'string'"
                                                        v-model="workflow[param.nodeId].inputs[param.name]"
                                                        @input="autoGrow($event.target)"
                                                        @change="updateWorkflow"
                                                        class="param-input param-textarea"
                                                        rows="1"
                                                    ></textarea>
                                                    <input
                                                        v-else
                                                        type="number"
                                                        v-model="workflow[param.nodeId].inputs[param.name]"
                                                        @change="updateWorkflow"
                                                        class="param-input"
                                                    >
                                                </template>
                                            </template>
                                        </template>
                                    </template>
                                    <template v-else>
                                        <div class="param-connection">
                                            连接到节点 #{{ param.value[0] }} 的输出 {{ param.value[1] }}
                                        </div>
                                    </template>
                                </template>
                            </div>
                        </div>
                        
                        <!-- 在每个卡片后添加拖拽区域 -->
                        <div 
                            class="drop-zone"
                            @dragover.prevent="handleDropZoneDragOver($event, index + 1)"
                            @drop="handleDropZoneDrop($event, index + 1)"
                            :class="{ 'active': dragOverZoneIndex === index + 1 }"
                        ></div>
                    </template>
                </div>

                <!-- 搜索按钮部分 -->
                <div class="search-button-container">
                    <button class="search-toggle-btn" @click="showSearch = true">
                        <i class="fas fa-search"></i>
                    </button>
                </div>

                <!-- 搜索弹窗部分 -->
                <transition name="fade">
                    <div v-if="showSearch" class="search-overlay" @click.self="closeSearch">
                        <div class="search-popup">
                            <div class="search-popup-header">
                                <input
                                    type="text"
                                    v-model="searchQuery"
                                    placeholder="搜索节点编号(例: #3)或参数名..."
                                    class="popup-search-input"
                                    ref="searchInput"
                                    @keyup.esc="closeSearch"
                                >
                                <button class="close-search-btn" @click="closeSearch">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="search-results">
                                <div v-if="displayedParams.length > 0">
                                    <div v-for="param in displayedParams" :key="param.id" class="param-item">
                                        <label class="param-checkbox">
                                            <input 
                                                type="checkbox" 
                                                v-model="selectedParams[param.id]"
                                            >
                                            <span class="param-info">
                                                <span class="param-name">
                                                    <span class="node-id">#{{ param.nodeId }}</span>
                                                    {{ param.name }}
                                                </span>
                                            </span>
                                        </label>
                                    </div>
                                </div>
                                <div v-else class="no-results">
                                    未找到匹配的参数
                                </div>
                            </div>
                        </div>
                    </div>
                </transition>
            </div>

            <!-- Main panel -->
            <div class="main-panel">
                <div class="latest-image-container">
                    <template v-if="selectedHistoryImage">
                        <img 
                            :src="selectedHistoryImage" 
                            class="latest-image"
                            @error="handleImageError"
                            alt="历史图片"
                        >
                        <!-- 添加下载按钮 -->
                        <div class="image-controls">
                            <el-button 
                                type="primary" 
                                size="small" 
                                @click="downloadImage"
                                circle
                            >
                                <i class="fas fa-download"></i>
                            </el-button>

                            <!-- 添加新按钮 -->
                            <el-button
                                type="primary"
                                circle
                                @click="openInPhotoshop"
                                title="在Photoshop中打开"
                            >
                                <i class="fas fa-edit"></i>
                            </el-button>
                        </div>
                    </template>
                    <template v-else-if="outputImage">
                        <img 
                            :src="outputImage" 
                            class="latest-image"
                            @error="handleImageError"
                            :alt="outputPrompt || '新生成的图片'"
                        >
                        <!-- 添加下载按钮 -->
                        <div class="image-controls">
                            <el-button 
                                type="primary" 
                                size="small" 
                                @click="downloadImage"
                                circle
                            >
                                <i class="fas fa-download"></i>
                            </el-button>

                            <!-- 添加新按钮 -->
                            <el-button
                                type="primary"
                                circle
                                @click="openInPhotoshop"
                                title="在Photoshop中打开"
                            >
                                <i class="fas fa-edit"></i>
                            </el-button>
                        </div>
                    </template>
                    <template v-else-if="loading">
                        <div class="loading-indicator">
                            <div class="loading-spinner"></div>
                            <div>生成中...</div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Right history panel -->
            <div class="history-panel" :class="{ 'hidden': !showSidePanels }">
                <div class="logo-container">
                    <div class="logo-text">本软件开源免费，软件更新及最新配套工作流，
请关注小红书、哔哩哔哩：猫咪老师Reimagined</div>
                </div>
                <div class="history-images-container">
                    <div v-for="image in savedImages.slice(0, 5)" :key="image.path" class="history-image-item">
                        <img 
                            :src="image.path" 
                            class="history-image"
                            @error="handleImageError"
                            alt="历史图片"
                            @click="showHistoryImage(image)"
                            :class="{ 'selected': selectedHistoryImage === image.path }"
                        >
                    </div>
                </div>
            </div>
        </div>

        <!-- 设置对话框 -->
        <el-dialog
            v-model="showSettings"
            title="设置"
            width="500px"
            :close-on-click-modal="false"
        >
            <div class="settings-content">
                <div class="setting-item">
                    <div class="setting-label">ComfyUI 路径:</div>
                    <el-input 
                        v-model="comfyuiPath"
                        placeholder="请输入 ComfyUI 路径"
                    >
                        <template #append>
                            <el-button @click="saveSettings">
                                确认
                            </el-button>
                        </template>
                    </el-input>
                    <div class="setting-hint">
                        例如: C:\path\to\ComfyUI 或 /path/to/ComfyUI
                    </div>
                </div>
            </div>
        </el-dialog>

        <!-- 修改遮罩绘制对话框的模板部分 -->
        <el-dialog
            v-model="showMaskDrawer"
            title="绘制遮罩"
            width="800px"
            :close-on-click-modal="false"
            class="mask-drawer-dialog"
            :destroy-on-close="true"
            @closed="handleMaskDrawerClose"
        >
            <div class="mask-drawer-container">
                <div class="canvas-container">
                    <img 
                        class="base-image"
                        ref="baseImage"
                        crossorigin="anonymous"
                        @load="onBaseImageLoad"
                        @error="(e) => console.error('Image load error:', e)"
                        alt="基础图片"
                    />
                    <canvas 
                        ref="maskCanvas" 
                        class="mask-canvas"
                        @mousedown="startDrawing"
                        @mousemove="draw"
                        @mouseup="stopDrawing"
                        @mouseleave="stopDrawing"
                    ></canvas>
                </div>
                <div class="drawing-controls">
                    <div class="brush-size-control">
                        <span>笔刷大小:</span>
                        <el-slider
                            v-model="brushSize"
                            :min="1"
                            :max="50"
                            :step="1"
                        />
                    </div>
                    <el-button @click="clearMask">清除</el-button>
                    <el-button type="primary" @click="saveMask">确认</el-button>
                </div>
            </div>
        </el-dialog>

        <!-- 添加工作流选择弹窗 -->
        <el-dialog
            v-model="showWorkflowDialog"
            title="选择工作流"
            width="80%"
            :close-on-click-modal="false"
            class="workflow-dialog"
        >
            <div class="workflow-grid-container">
                <div class="workflow-grid">
                    <div
                        v-for="workflow in sortedWorkflows"
                        :key="workflow.path"
                        class="workflow-item"
                        draggable="true"
                        @dragstart="handleWorkflowDragStart($event, workflow)"
                        @dragend="handleWorkflowDragEnd"
                        @dragover.prevent
                        @drop="handleWorkflowDrop($event, workflow)"
                        @click="selectWorkflow(workflow)"
                        :class="{ 'active': currentWorkflow === workflow.path }"
                    >
                        <div class="workflow-content">
                            <div class="workflow-name">{{ workflow.name }}</div>
                            <div class="workflow-path">{{ workflow.path }}</div>
                        </div>
                        <div class="workflow-actions">
                            <i class="fas fa-grip-vertical drag-handle"></i>
                        </div>
                    </div>
                </div>
            </div>
        </el-dialog>
    </div>

    <!-- 在 <script> 标签前添加组件模板 -->
    <template id="fixed-options-selector">
        <select 
            :value="modelValue"
            class="param-input"
            @change="$emit('update:modelValue', $event.target.value); $emit('change', $event)"
        >
            <option 
                v-for="option in optionsList" 
                :key="option"
                :value="option"
            >
                {{ option }}
            </option>
        </select>
    </template>

    <!-- 在现有的 <script> 标签内添加组件定义 -->
    <script>
        // 首先创建 Vue 应用
        const app = Vue.createApp({
            data() {
                return {
                    workflow: null,
                    workflows: [],
                    currentWorkflow: 'image.json',
                    samplers: [
                        'euler',
                        'euler_ancestral',
                        'dpm_2_ancestral',
                        'dpmpp_2m',
                        'dpmpp_sde'
                    ],
                    loading: false,
                    searchQuery: '',
                    selectedParams: {},
                    selectedImage: null,
                    connectionId: `ws_${Date.now()}`,
                    outputImage: null,
                    outputPrompt: null,
                    ws: null,
                    imageLoadError: false,
                    batchCount: 1,
                    savedImages: [],
                    isDragging: false,
                    draggedParamId: null,
                    paramOrder: [],
                    selectedHistoryImage: null,
                    paramCustomNames: {},
                    showSearch: false,
                    comfyuiPath: '',
                    showSettings: false,
                    checkpoints: [],
                    loraModels: [],
                    controlnetModels: [],
                    unetModels: [],
                    vaeModels: [],
                    modelDirectories: [],  // 存储所有模型��录
                    modelLists: {},       // 存储每个目录的模���列表
                    dragOverTop: null,
                    dragOverBottom: null,
                    preprocessors: [],  // 存储预处理器列表
                    showMaskDrawer: false,
                    brushSize: 20,
                    isDrawing: false,
                    currentNodeId: null,
                    ctx: null,
                    imageCtx: null,
                    showSidePanels: true, // Add this new property
                    splitScreenMode: false, // 添加分屏模式状态
                    showWorkflowDialog: false,
                    workflowOrder: [],
                    draggedWorkflow: null,
                    currentWorkflowName: null,  // 添加这行来更新显示的工作流名称
                }
            },
            computed: {
                filteredParams() {
                    if (!this.workflow) return [];
                    
                    // 获取所有参数
                    const allParams = [];
                    Object.entries(this.workflow).forEach(([nodeId, node]) => {
                        if (node.inputs) {
                            Object.entries(node.inputs).forEach(([key, value]) => {
                                const paramId = `${nodeId}_${key}`;
                                if (!Array.isArray(value)) {
                                    allParams.push({
                                        id: paramId,
                                        nodeId,
                                        name: key,
                                        value: value
                                    });
                                }
                            });
                        }
                    });
                    
                    // 如果有搜索查询，过滤参数
                    if (this.searchQuery) {
                        const query = this.searchQuery.toLowerCase().trim();
                        return allParams.filter(param => {
                            if (query.startsWith('#')) {
                                return param.nodeId === query.substring(1);
                            }
                            return param.nodeId.includes(query) || 
                                   param.name.toLowerCase().includes(query);
                        });
                    }
                    
                    // 如果有参数顺序，按照顺序排序
                    if (this.paramOrder.length > 0) {
                        return allParams.sort((a, b) => {
                            const indexA = this.paramOrder.indexOf(a.id);
                            const indexB = this.paramOrder.indexOf(b.id);
                            if (indexA === -1) return 1;
                            if (indexB === -1) return -1;
                            return indexA - indexB;
                        });
                    }
                    
                    return allParams;
                },
                
                displayedParams() {
                    if (!this.workflow) return [];
                    
                    // 获取所有参数
                    const allParams = [];
                    Object.entries(this.workflow).forEach(([nodeId, node]) => {
                        if (node.inputs) {
                            Object.entries(node.inputs).forEach(([key, value]) => {
                                const paramId = `${nodeId}_${key}`;
                                if (!Array.isArray(value)) {
                                    allParams.push({
                                        id: paramId,
                                        nodeId,
                                        name: key,
                                        value: value
                                    });
                                }
                            });
                        }
                    });

                    // 如果有搜索查询，只显示搜索结果
                    if (this.searchQuery) {
                        const query = this.searchQuery.toLowerCase().trim();
                        return allParams.filter(param => {
                            if (query.startsWith('#')) {
                                return param.nodeId === query.substring(1);
                            }
                            return param.nodeId.includes(query) || 
                                   param.name.toLowerCase().includes(query);
                        });
                    } 
                    
                    // 如果没有搜索，显示已选中的参数
                    return allParams.filter(param => this.selectedParams[param.id]);
                },
                sortedWorkflows() {
                    if (!this.workflows || !this.workflowOrder.length) return this.workflows;
                    
                    const orderedWorkflows = [...this.workflows];
                    orderedWorkflows.sort((a, b) => {
                        const indexA = this.workflowOrder.indexOf(a.path);
                        const indexB = this.workflowOrder.indexOf(b.path);
                        if (indexA === -1) return 1;
                        if (indexB === -1) return -1;
                        return indexA - indexB;
                    });
                    return orderedWorkflows;
                }
            },
            methods: {
                async loadWorkflowList() {
                    try {
                        const response = await axios.get('/api/workflows');
                        this.workflows = response.data;
                        
                        // 设置初始工作流名称
                        if (this.currentWorkflow) {
                            const currentWorkflowData = this.workflows.find(w => w.path === this.currentWorkflow);
                            if (currentWorkflowData) {
                                this.currentWorkflowName = currentWorkflowData.name;
                            }
                        }
                        
                        await this.loadWorkflowOrder();
                    } catch (error) {
                        console.error('加载工作流列表失败:', error);
                        this.$message.error('加载工作流列表失败: ' + error.message);
                    }
                },
                async loadWorkflow() {
                    this.loading = true;
                    try {
                        const response = await axios.get(`/api/workflow/${this.currentWorkflow}`);
                        this.workflow = response.data;
                        
                        // 自动选中所有可编辑参数
                        Object.entries(this.workflow).forEach(([nodeId, node]) => {
                            if (node.inputs) {
                                Object.entries(node.inputs).forEach(([key, value]) => {
                                    if (!Array.isArray(value)) {
                                        const paramId = `${nodeId}_${key}`;
                                        this.selectedParams[paramId] = true;
                                    }
                                });
                            }
                        });
                        
                        // 加载预设
                        await this.loadPreset();
                        
                    } catch (error) {
                        console.error('加载工作流失败:', error);
                        this.$message.error('加载工作流失败: ' + error.message);
                    } finally {
                        this.loading = false;
                    }
                },
                async executeWorkflow() {
                    this.loading = true;
                    try {
                        // 在执行前更新有随机子
                        Object.entries(this.workflow).forEach(([nodeId, node]) => {
                            if (node.seed_random && node.inputs && node.inputs.seed !== undefined) {
                                node.inputs.seed = Math.floor(Math.random() * 1000000000);
                            }
                        });
                        
                        // 批量执行指次数
                        for (let i = 0; i < this.batchCount; i++) {
                            // 如果不是第一次，需要重新生成随机种子
                            if (i > 0) {
                                Object.entries(this.workflow).forEach(([nodeId, node]) => {
                                    if (node.seed_random && node.inputs && node.inputs.seed !== undefined) {
                                        node.inputs.seed = Math.floor(Math.random() * 1000000000);
                                    }
                                });
                            }
                            
                            const response = await axios.post('/api/execute', this.workflow);
                            console.log('执行结果:', response.data);
                            
                            // 等待一秒，避免请求过于频繁
                            if (i < this.batchCount - 1) {
                                await new Promise(resolve => setTimeout(resolve, 1000));
                            }
                        }
                        
                        this.$message({
                            message: '工作流执行成功',
                            type: 'info',
                            duration: 2000
                        });
                    } catch (error) {
                        console.error('执行工作流失败:', error);
                        this.$message({
                            message: error.response?.data?.details || '执行工作流失败',
                            type: 'error',
                            duration: 3000
                        });
                    } finally {
                        this.loading = false;
                    }
                },
                async updateWorkflow() {
                    try {
                        await axios.post(`/api/workflow/${this.currentWorkflow}`, this.workflow);
                    } catch (error) {
                        console.error('更新工作流失败:', error);
                        this.$message({
                            message: '更新工作流失败',
                            type: 'error',
                            duration: 2000
                        });
                    }
                },
                unselectParam(paramId) {
                    this.selectedParams[paramId] = false;
                    this.$forceUpdate();
                    this.savePreset();
                },
                getParamType(value) {
                    // 如果是子属性参数，返回空字符串
                    if (typeof value === 'object' && value !== null && !Array.isArray(value)) {
                        return '';
                    }
                    // 其他类型保持不变
                    if (Array.isArray(value)) return '节点连接';
                    if (typeof value === 'number') return '数值';
                    if (typeof value === 'string') return '文本';
                    return '其他';
                },
                async loadPreset() {
                    try {
                        const response = await axios.get(`/api/preset/${this.currentWorkflow}`);
                        if (response.data.selectedParams) {
                            this.selectedParams = response.data.selectedParams;
                            console.log('Loaded selectedParams:', this.selectedParams);
                        }
                        if (response.data.paramCustomNames) {
                            this.paramCustomNames = response.data.paramCustomNames;
                            console.log('Loaded paramCustomNames:', this.paramCustomNames);
                        }
                        if (response.data.paramOrder) {
                            this.paramOrder = response.data.paramOrder;
                            console.log('Loaded paramOrder:', this.paramOrder);
                        }
                        this.$forceUpdate(); // Force Vue to re-render the component
                    } catch (error) {
                        console.error('加载预设失败:', error);
                    }
                },
                async savePreset() {
                    try {
                        await axios.post(`/api/preset/${this.currentWorkflow}`, {
                            selectedParams: this.selectedParams,
                            paramCustomNames: this.paramCustomNames,
                            paramOrder: this.paramOrder
                        });
                        this.$message({
                            message: '预设保存成功',
                            type: 'info',
                            duration: 2000
                        });
                    } catch (error) {
                        console.error('保存预设失败:', error);
                        this.$message({
                            message: '保存预设失败',
                            type: 'error',
                            duration: 2000
                        });
                    }
                },
                selectAllParams(nodeId) {
                    const nodeParams = this.filteredParams.filter(p => p.nodeId === nodeId);
                    nodeParams.forEach(param => {
                        this.selectedParams[param.id] = true;
                    });
                },
                async handleImageUpload(event, nodeId) {
                    const file = event.target.files[0];
                    if (!file) return;
                    
                    try {
                        const reader = new FileReader();
                        reader.onload = async (e) => {
                            const base64Data = e.target.result;
                            
                            try {
                                const response = await axios.post(
                                    `/api/comfyui/upload/${nodeId}`,
                                    { 
                                        image: base64Data,
                                        nodeId: nodeId
                                    }
                                );
                                
                                if (response.data.success) {
                                    // 更新工作流中的图片路径
                                    this.workflow[nodeId].inputs.image = response.data.image_path;
                                    // 更新预览图
                                    this.workflow[nodeId].preview = base64Data;
                                    // 保存工作流更新
                                    await this.updateWorkflow();
                                    
                                    this.$message({
                                        message: '图片上传成功',
                                        type: 'success',
                                        duration: 2000
                                    });
                                } else {
                                    throw new Error(response.data.error || '上传失败');
                                }
                            } catch (error) {
                                console.error('上传图片失败:', error);
                                this.$message.error(error.response?.data?.error || error.message || '上传图片失败');
                            }
                        };
                        
                        reader.readAsDataURL(file);
                    } catch (error) {
                        console.error('读取文件失败:', error);
                        this.$message.error('读取文件失败');
                    }
                },
                isImageLoaderNode(nodeId) {
                    // 检查是否为 LoadImage 或 LoadImageMask 类型的节点
                    return this.workflow[nodeId]?.class_type === 'LoadImage' || 
                           this.workflow[nodeId]?.class_type === 'LoadImageMask';
                },
                connectWebSocket() {
                    this.ws = new WebSocket('ws://localhost:3001');
                    
                    this.ws.onmessage = async (event) => {
                        try {
                            const data = JSON.parse(event.data);
                            if (data.type === 'image') {
                                if (data.image) {
                                    // WebSocket传来的base64图片
                                    this.outputImage = 'data:image/png;base64,' + data.image;
                                    this.selectedHistoryImage = null; // 清除历史图片选择
                                } else {
                                    // 如果没有base64数据尝试加载最新的输出片
                                    await this.loadLatestImage();
                                }
                                this.outputPrompt = data.prompt;
                            }
                        } catch (error) {
                            console.error('Error processing WebSocket message:', error);
                        }
                    };
                },
                async loadLatestImage() {
                    try {
                        const response = await axios.get('/api/output-images');
                        if (response.data.length > 0) {
                            const imagePath = response.data[0].path;
                            // 添加时间防止缓存
                            this.outputImage = `${imagePath}?t=${Date.now()}`;
                            console.log('Loading image:', this.outputImage);
                        }
                    } catch (error) {
                        console.error('加载图片失败:', error);
                    }
                },
                handleImageError(e) {
                    console.error('图片加载失败:', e);
                    this.imageLoadError = true;
                },
                async downloadImage() {
                    if (!this.outputImage && !this.selectedHistoryImage) return;
                    
                    try {
                        const imageUrl = this.selectedHistoryImage || this.outputImage;
                        const response = await fetch(imageUrl);
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        
                        // 创建下载链接
                        const a = document.createElement('a');
                        a.href = url;
                        
                        // 根据选择的文件夹构建文件名
                        let filename = `image-${Date.now()}.png`;
                        a.download = filename;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                        
                        this.$message({
                            message: '图片下载成功',
                            type: 'success',
                            duration: 2000
                        });
                    } catch (error) {
                        console.error('下载图片失败:', error);
                        this.$message.error('下载图片失败');
                    }
                },
                async copyImage() {
                    if (!this.outputImage) return;
                    
                    try {
                        const response = await fetch(this.outputImage);
                        const blob = await response.blob();
                        await navigator.clipboard.write([
                            new ClipboardItem({
                                [blob.type]: blob
                            })
                        ]);
                        this.$message({
                            message: '图片已复制到剪贴板',
                            type: 'info',
                            duration: 2000
                        });
                    } catch (error) {
                        console.error('复制图片失败:', error);
                        this.$message({
                            message: '复制图片失败',
                            type: 'error',
                            duration: 2000
                        });
                    }
                },
                toggleSeedMode(nodeId) {
                    if (!this.workflow[nodeId].seed_random) {
                        this.workflow[nodeId].seed_random = true;
                        // 设置个随机种子
                        this.workflow[nodeId].inputs.seed = Math.floor(Math.random() * 1000000000);
                    } else {
                        this.workflow[nodeId].seed_random = false;
                    }
                    this.updateWorkflow();
                },
                autoGrow(element) {
                    element.style.height = 'auto';
                    element.style.height = (element.scrollHeight) + 'px';
                },
                async loadSavedImages() {
                    try {
                        const response = await axios.get('/api/saved-images');
                        // 只取最新的5张图片
                        this.savedImages = response.data.slice(0, 5);
                    } catch (error) {
                        console.error('加载保存图片失败:', error);
                    }
                },
                handleDragOver(event) {
                    this.isDragging = true;
                    event.dataTransfer.dropEffect = 'copy';
                },
                handleDragLeave() {
                    this.isDragging = false;
                },
                async handleDrop(event, nodeId) {
                    this.isDragging = false;
                    const file = event.dataTransfer.files[0];
                    if (!file || !file.type.startsWith('image/')) {
                        alert('请上传图片文件');
                        return;
                    }
                    
                    try {
                        const reader = new FileReader();
                        reader.onload = async (e) => {
                            const base64Data = e.target.result;
                            
                            try {
                                const response = await axios.post(
                                    `/api/comfyui/upload/${nodeId}`,
                                    { 
                                        image: base64Data,
                                        nodeId: nodeId
                                    }
                                );
                                
                                if (response.data.success) {
                                    this.workflow[nodeId].inputs.image = response.data.image_path;
                                    this.workflow[nodeId].preview = base64Data;
                                    await this.updateWorkflow();
                                    console.log('图片上传成功');
                                } else {
                                    throw new Error(response.data.error || '上传失败');
                                }
                            } catch (error) {
                                console.error('上传图片失败:', error);
                                alert(error.response?.data?.error || error.message || '上传图片失败');
                            }
                        };
                        
                        reader.readAsDataURL(file);
                    } catch (error) {
                        console.error('读取文件失败:', error);
                        alert('读取文件失败');
                    }
                },
                handleDragStart(event, paramId) {
                    this.draggedParamId = paramId;
                    event.dataTransfer.effectAllowed = 'move';
                },
                handleParamDragOver(event, paramId) {
                    if (this.draggedParamId === paramId) return;
                    
                    const rect = event.currentTarget.getBoundingClientRect();
                    const midY = rect.top + rect.height / 2;
                    
                    // 清除前状态
                    this.dragOverTop = null;
                    this.dragOverBottom = null;
                    
                    // 设置新的状态
                    if (event.clientY < midY) {
                        this.dragOverTop = paramId;
                    } else {
                        this.dragOverBottom = paramId;
                    }
                    
                    event.dataTransfer.dropEffect = 'move';
                },
                handleParamDragEnd() {
                    this.draggedParamId = null;
                    this.dragOverTop = null;
                    this.dragOverBottom = null;
                },
                handleParamDrop(event, targetParamId) {
                    if (!this.draggedParamId || this.draggedParamId === targetParamId) {
                        this.draggedParamId = null;
                        this.dragOverTop = null;
                        this.dragOverBottom = null;
                        return;
                    }
                    
                    const rect = event.currentTarget.getBoundingClientRect();
                    const midY = rect.top + rect.height / 2;
                    const insertBefore = event.clientY < midY;
                    
                    // 获取当前显示的参数列表
                    const currentParams = this.filteredParams
                        .filter(param => this.selectedParams[param.id])
                        .map(param => param.id);
                    
                    // 找到源和目标参数的索引
                    const draggedIndex = currentParams.indexOf(this.draggedParamId);
                    const targetIndex = currentParams.indexOf(targetParamId);
                    
                    if (draggedIndex !== -1) {
                        // 从当前位置移除
                        currentParams.splice(draggedIndex, 1);
                        
                        // 计算新的插入位置
                        let newIndex = targetIndex;
                        if (!insertBefore && draggedIndex > targetIndex) {
                            newIndex += 1;
                        }
                        if (insertBefore && draggedIndex < targetIndex) {
                            newIndex -= 1;
                        }
                        
                        // 在新位置插入
                        currentParams.splice(newIndex, 0, this.draggedParamId);
                        
                        // 更新参数顺序
                        this.paramOrder = currentParams;
                        
                        // 保存新的顺序
                        this.savePreset();
                    }
                    
                    // 清理拖拽状态
                    this.draggedParamId = null;
                    this.dragOverTop = null;
                    this.dragOverBottom = null;
                },
                showHistoryImage(image) {
                    this.selectedHistoryImage = image.path;
                },
                incrementCount() {
                    if (this.batchCount < 10) {
                        this.batchCount++;
                    }
                },
                decrementCount() {
                    if (this.batchCount > 1) {
                        this.batchCount--;
                    }
                },
                async loadSettings() {
                    try {
                        const response = await axios.get('/api/settings');
                        if (response.data) {
                            this.comfyuiPath = response.data.comfyuiPath;  // 直接设置到 comfyuiPath
                            // 如果没有设置 ComfyUI 路径，显示设置对话框
                            if (!this.comfyuiPath) {
                                this.showSettings = true;
                            }
                        }
                    } catch (error) {
                        console.error('加载设置失败:', error);
                    }
                },
                async saveSettings() {
                    try {
                        await axios.post('/api/settings', {
                            comfyuiPath: this.comfyuiPath  // 修改这里，直接使用 comfyuiPath
                        });
                        this.$message.success('设置保存成功');
                        this.showSettings = false;
                        // 保存后刷新页面
                        window.location.reload();
                    } catch (error) {
                        console.error('保存设置失败:', error);
                        this.$message.error('保存设置失败');
                    }
                },
                async loadModelLists() {
                    try {
                        // 加载所有类型的模型列表
                        const types = ['checkpoints', 'loras', 'controlnet', 'unet', 'vae'];  // 修改为正确的目录名
                        const responses = await Promise.all(
                            types.map(type => axios.get(`/api/models/${type}`))
                        );
                        
                        [
                            this.checkpoints,
                            this.loraModels,
                            this.controlnetModels,
                            this.unetModels,
                            this.vaeModels
                        ] = responses.map(response => response.data);
                        
                        // 详细的调试输出
                        console.log('加载的模型列表:', {
                            checkpoints: this.checkpoints?.length,
                            loras: this.loraModels?.length,  // 修改日志输出
                            controlnet: this.controlnetModels?.length,
                            unet: this.unetModels?.length,
                            vae: this.vaeModels?.length,
                            loraDetail: this.loraModels
                        });
                    } catch (error) {
                        console.error('加载模型列表失败:', error);
                    }
                },
                handleCheckpointChange(nodeId, value) {
                    const paramMappings = {
                        'CheckpointLoaderSimple': ['ckpt_name', 'ckpt', 'model_name'],
                        'LoraLoader': ['lora_name', 'lora'],
                        'ControlNetLoader': ['control_net_name', 'control', 'model'],
                        'UNETLoader': ['unet_name', 'unet', 'model_name'],
                        'UnetLoaderGGUF': ['unet_name', 'unet'],
                        'VAELoader': ['vae_name', 'vae', 'model_name']
                    };
                    
                    const nodeType = Object.keys(paramMappings).find(type => 
                        this.workflow[nodeId].class_type.includes(type)  // 修复语法错误
                    );
                    
                    if (!nodeType) return;
                    
                    paramMappings[nodeType].forEach(param => {
                        if (this.workflow[nodeId].inputs.hasOwnProperty(param)) {
                            this.workflow[nodeId].inputs[param] = value;
                        }
                    });
                    
                    this.updateWorkflow();
                },
                isModelParameter(nodeId, paramName) {
                    const node = this.workflow[nodeId];
                    if (!node) return false;
                    
                    // 特殊处理 UnetLoaderGGUF 节点
                    if (node.class_type === 'UnetLoaderGGUF' && 
                        (paramName === 'unet_name' || paramName === 'unet')) {
                        console.log('找到 UnetLoaderGGUF 节点的参数:', paramName);
                        return true;
                    }
                    
                    // 检查节点类型和参数名的映射关系
                    const modelTypeMap = {
                        'CheckpointLoaderSimple': {
                            params: ['ckpt_name', 'ckpt', 'model_name'],
                            models: this.checkpoints
                        },
                        'LoraLoader': {
                            params: ['lora_name', 'lora'],
                            models: this.loraModels
                        },
                        'ControlNetLoader': {
                            params: ['control_net_name', 'control', 'model'],
                            models: this.controlnetModels
                        },
                        'UNETLoader': {
                            params: ['unet_name', 'unet', 'model_name'],
                            models: this.unetModels
                        },
                        'VAELoader': {
                            params: ['vae_name', 'vae', 'model_name'],
                            models: this.vaeModels
                        }
                    };
                    
                    const nodeType = Object.keys(modelTypeMap).find(type => 
                        node.class_type === type || node.class_type.includes(type)
                    );
                    
                    return nodeType && modelTypeMap[nodeType].params.includes(paramName);
                },
                getModelList(nodeId, paramName) {
                    const node = this.workflow[nodeId];
                    if (!node) return [];
                    
                    // 特殊处理 UnetLoaderGGUF 节点，只返回 .gguf 文件
                    if (node.class_type === 'UnetLoaderGGUF' && 
                        (paramName === 'unet_name' || paramName === 'unet')) {
                        console.log('获取 GGUF 型列表，参数:', paramName);
                        return this.unetModels.filter(model => 
                            model.name.toLowerCase().endsWith('.gguf')
                        );
                    }
                    
                    // 根据节点类型返回对应的模型列表
                    const modelTypeMap = {
                        'CheckpointLoaderSimple': this.checkpoints,
                        'LoraLoader': this.loraModels,
                        'ControlNetLoader': this.controlnetModels,
                        'UNETLoader': this.unetModels,
                        'VAELoader': this.vaeModels
                    };
                    
                    const nodeType = Object.keys(modelTypeMap).find(type => 
                        node.class_type === type || node.class_type.includes(type)
                    );
                    
                    return nodeType ? modelTypeMap[nodeType] : [];
                },
                handleDropZoneDragOver(event, index) {
                    event.preventDefault();
                    if (this.draggedParamId) {
                        this.dragOverZoneIndex = index;
                    }
                },
                handleDropZoneDrop(event, index) {
                    if (!this.draggedParamId) return;
                    
                    // 获取当前显示的参数列表
                    const currentParams = this.filteredParams
                        .filter(param => this.selectedParams[param.id])
                        .map(param => param.id);
                    
                    // 找到被拖拽参数的当前索引
                    const draggedIndex = currentParams.indexOf(this.draggedParamId);
                    
                    if (draggedIndex !== -1) {
                        // 从当前位置移除
                        currentParams.splice(draggedIndex, 1);
                        
                        // 在新位置插入
                        currentParams.splice(index, 0, this.draggedParamId);
                        
                        // 更新参数顺序
                        this.paramOrder = currentParams;
                        
                        // 保存新的顺序
                        this.savePreset();
                    }
                    
                    // 清理状态
                    this.draggedParamId = null;
                    this.dragOverZoneIndex = null;
                },
                // 判断是否是理器参数
                isPreprocessorParameter(nodeId, paramName) {
                    const node = this.workflow[nodeId];
                    return node && 
                        node.class_type === 'AIO_Preprocessor' && 
                        paramName === 'preprocessor';
                },
                // 获取预处理器列表
                getPreprocessorList(nodeId, paramName) {
                    if (this.isPreprocessorParameter(nodeId, paramName)) {
                        return this.preprocessors;
                    }
                    return [];
                },
                getParamValue(param) {
                    const node = this.workflow[param.nodeId];
                    if (!node || !node.inputs) return '';
                    return node.inputs[param.name];
                },
                selectParam(param) {
                    // 实现参数选择逻辑
                    this.showSearch = false;
                    this.searchQuery = '';
                    // 可以添加其他选择后的操作
                },
                async loadPreprocessors() {
                    try {
                        const response = await axios.get('/api/preprocessors');
                        this.preprocessors = response.data;
                        console.log('加载的预处理器列表:', this.preprocessors);
                    } catch (error) {
                        console.error('加载处理器列表失败:', error);
                    }
                },
                isSliderParameter(nodeId, paramName) {
                    // 扩展需要使用滑块的参数列表
                    const sliderParams = [
                        'steps',
                        'cfg',
                        'denoise',
                        'strength',
                        'noise',
                        'scale',
                        'strength_model'  // 添加 strength_model 参数
                    ];
                    return sliderParams.includes(paramName);
                },
                getSliderConfig(paramName) {
                    // 为不同参数配置适当的滑块范围
                    const configs = {
                        steps: { min: 1, max: 100, step: 1 },
                        cfg: { min: 1, max: 20, step: 0.1 },
                        denoise: { min: 0, max: 1, step: 0.01 },
                        strength: { min: 0, max: 1, step: 0.01 },
                        noise: { min: 0, max: 1, step: 0.01 },
                        scale: { min: 0, max: 2, step: 0.01 },
                        strength_model: { min: 0.01, max: 1, step: 0.01 }  // 使用与 cfg 相同的配置
                    };
                    return configs[paramName] || { min: 0, max: 100, step: 1 };
                },
                async openMaskDrawer(nodeId) {
                    console.log('Opening mask drawer for node:', nodeId);
                    this.currentNodeId = nodeId;
                    
                    try {
                        // 获取原图
                        const response = await axios.get(`/api/get-original-image/${nodeId}`);
                        console.log('Got response:', response.data);
                        
                        if (response.data.image) {
                            this.showMaskDrawer = true;
                            this.$nextTick(() => {
                                const baseImage = this.$refs.baseImage;
                                if (baseImage) {
                                    baseImage.src = response.data.image;
                                    console.log('Set image source:', response.data.image.substring(0, 100) + '...');
                                } else {
                                    console.error('Base image element not found');
                                }
                            });
                        } else {
                            throw new Error('获取原图失败: 返回数据中没有图片');
                        }
                    } catch (error) {
                        console.error('打开遮罩绘制失败:', error);
                        this.$message.error(error.response?.data?.error || error.message || '获取原图失败');
                    }
                },
                initializeCanvases(sourceImage) {
                    console.log('Initializing canvases with source image:', sourceImage);
                    const maskCanvas = this.$refs.maskCanvas;
                    const baseImage = this.$refs.baseImage;
                    
                    if (!maskCanvas || !baseImage) {
                        console.error('Canvas or base image not found');
                        return;
                    }

                    const container = maskCanvas.parentElement;
                    console.log('Container dimensions:', container.clientWidth, container.clientHeight);

                    // 获取容器尺寸
                    const containerWidth = container.clientWidth;
                    const containerHeight = container.clientHeight;
                    
                    // 计算缩放比例
                    const scale = Math.min(
                        containerWidth / sourceImage.naturalWidth,
                        containerHeight / sourceImage.naturalHeight
                    );
                    
                    // 计算显示尺寸
                    const displayWidth = sourceImage.naturalWidth * scale;
                    const displayHeight = sourceImage.naturalHeight * scale;
                    
                    console.log('Display dimensions:', displayWidth, displayHeight);
                    
                    // 设置画布尺寸
                    maskCanvas.width = displayWidth;
                    maskCanvas.height = displayHeight;
                    
                    // 计算居中位置
                    const left = (containerWidth - displayWidth) / 2;
                    const top = (containerHeight - displayHeight) / 2;
                    
                    // 设置图片和画布的位置和尺寸
                    baseImage.style.width = `${displayWidth}px`;
                    baseImage.style.height = `${displayHeight}px`;
                    baseImage.style.left = `${left}px`;
                    baseImage.style.top = `${top}px`;
                    
                    maskCanvas.style.width = `${displayWidth}px`;
                    maskCanvas.style.height = `${displayHeight}px`;
                    maskCanvas.style.left = `${left}px`;
                    maskCanvas.style.top = `${top}px`;
                    
                    // 初始化画布上下文
                    this.ctx = maskCanvas.getContext('2d', { alpha: true });
                    this.ctx.clearRect(0, 0, maskCanvas.width, maskCanvas.height);
                },
                startDrawing(e) {
                    this.isDrawing = true;
                    this.draw(e);
                },
                draw(e) {
                    if (!this.isDrawing) return;
                    
                    const canvas = this.$refs.maskCanvas;
                    const rect = canvas.getBoundingClientRect();
                    
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    
                    this.ctx.beginPath();
                    this.ctx.globalAlpha = 0.3;  // 降低透明度，使绘制更容易看到下面的图片
                    this.ctx.fillStyle = '#ffffff';
                    this.ctx.arc(x, y, this.brushSize, 0, Math.PI * 2);
                    this.ctx.fill();
                },
                stopDrawing() {
                    this.isDrawing = false;
                },
                clearMask() {
                    if (this.ctx) {
                        this.ctx.clearRect(0, 0, this.$refs.maskCanvas.width, this.$refs.maskCanvas.height);
                    }
                },
                async saveMask() {
                    const maskCanvas = this.$refs.maskCanvas;
                    const node = this.workflow[this.currentNodeId];
                    
                    try {
                        // 创建新画布来生成黑白遮罩
                        const outputCanvas = document.createElement('canvas');
                        outputCanvas.width = maskCanvas.width;
                        outputCanvas.height = maskCanvas.height;
                        const outputCtx = outputCanvas.getContext('2d');
                        
                        // 设置黑色背景
                        outputCtx.fillStyle = 'black';
                        outputCtx.fillRect(0, 0, outputCanvas.width, outputCanvas.height);
                        
                        // 获取遮画布的数据
                        const maskImageData = maskCanvas.getContext('2d').getImageData(0, 0, maskCanvas.width, maskCanvas.height);
                        const data = maskImageData.data;
                        
                        // 创建新的图像数据
                        const outputImageData = outputCtx.createImageData(maskCanvas.width, maskCanvas.height);
                        const outputData = outputImageData.data;
                        
                        // 处理每个像素
                        for (let i = 0; i < data.length; i += 4) {
                            const alpha = data[i + 3];
                            if (alpha > 0) {
                                outputData[i] = 255;     // R
                                outputData[i + 1] = 255; // G
                                outputData[i + 2] = 255; // B
                            } else {
                                outputData[i] = 0;       // R
                                outputData[i + 1] = 0;   // G
                                outputData[i + 2] = 0;   // B
                            }
                            outputData[i + 3] = 255;     // A
                        }
                        
                        outputCtx.putImageData(outputImageData, 0, 0);
                        const maskData = outputCanvas.toDataURL('image/png');
                        
                        if (node.class_type === 'ETN_LoadMaskBase64') {
                            // 更新 mask 参数的 base64 数据
                            node.inputs.mask = maskData.split(',')[1];
                            // 保存遮罩预览图
                            node.preview = maskData;
                        }
                        
                        await this.updateWorkflow();
                        this.showMaskDrawer = false;
                        
                        this.$message({
                            message: '遮罩保存成功',
                            type: 'success',
                            duration: 2000
                        });
                    } catch (error) {
                        console.error('保存遮罩失败:', error);
                        this.$message.error('保存遮罩失败');
                    }
                },
                // 修改遮罩绘制对话框的关闭处理
                handleMaskDrawerClose() {
                    const node = this.workflow[this.currentNodeId];
                    // 如果有保存的当前预览图，恢复它
                    if (node && node.currentPreview) {
                        node.preview = node.currentPreview;
                        delete node.currentPreview;
                    }
                },
                async uploadImage(nodeId, file) {
                    try {
                        const formData = new FormData();
                        formData.append('image', file);
                        formData.append('nodeId', nodeId);
                        
                        // 如果是 LoadImageMask 节点,只上传黑白遮罩图
                        if(this.workflow[nodeId]?.class_type === 'LoadImageMask') {
                            formData.append('type', 'mask');
                        }
                        
                        const response = await axios.post('/api/upload', formData);
                        // ...其他代码保持不变
                    } catch(error) {
                        console.error('上传图片失败:', error);
                    }
                },
                // 在处理工作流参数更新时
                updateWorkflowParam(nodeId, paramName, value) {
                    if (this.workflow[nodeId]) {
                        // 使用完整的参数名
                        this.workflow[nodeId].inputs[paramName] = value;
                    }
                },
                // 在读取工作流参数时
                getParamValue(nodeId, paramName) {
                    if (this.workflow[nodeId]?.inputs) {
                        // 使用完整的参数名
                        return this.workflow[nodeId].inputs[paramName];
                    }
                    return null;
                },
                async updateParam(nodeId, paramName, value) {
                    try {
                        await axios.post('/api/workflow/update', {
                            nodeId,
                            paramName,  // 使用完整参数名
                            value
                        });
                        if (this.workflow[nodeId]) {
                            this.workflow[nodeId].inputs[paramName] = value;
                        }
                    } catch (error) {
                        console.error('更新参数失败:', error);
                    }
                },
                processNode(node) {
                    return {
                        id: node.id,
                        title: node.title || '',  // 保持完整标题
                        // ...其他属性
                    };
                },
                getNodeTitle(nodeId) {
                    // 直接返回完整标题
                    return this.workflow[nodeId]?.title || nodeId;
                },
                displayNodeInfo(node) {
                    return {
                        id: node.id,
                        title: node.title || '',  // 保持完整标题
                        // ...其他属性
                    };
                },
                getParamDisplayName(param) {
                    return param.name;  // 只返回参数名
                },
                
                processParam(param) {
                    return {
                        ...param,  // 保留原有属性
                        name: param.name  // 保持完整参数名
                    };
                },
                onBaseImageLoad(event) {
                    console.log('Base image loaded');
                    this.initializeCanvases(event.target);
                },
                openAuthorLink() {
                    const url = 'https://space.bilibili.com/1054925384';
                    
                    // 使用 IPC 调用系统默认浏览器打开链接
                    if (window.electron && window.electron.ipcRenderer) {
                        window.electron.ipcRenderer.invoke('open-external-link', url)
                            .catch(error => {
                                console.error('打开链接失败:', error);
                                // 降级方案：使用普通的浏览器打开方式
                                this.openInBrowser(url);
                            });
                    } else {
                        this.openInBrowser(url);
                    }
                },
                // 添加新方法用于浏览器打开
                openInBrowser(url) {
                    try {
                        // 尝试使用 window.open
                        const newWindow = window.open(url, '_blank', 'noopener,noreferrer');
                        if (newWindow) {
                            newWindow.opener = null;
                        } else {
                            // 如果 window.open 被阻止，使用 location.href
                            window.location.href = url;
                        }
                    } catch (error) {
                        console.error('打开链接失败:', error);
                        // 最后的备选方案：创建并点击一个临时链接
                        const link = document.createElement('a');
                        link.href = url;
                        link.target = '_blank';
                        link.rel = 'noopener noreferrer';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    }
                },
                closeSearch() {
                    this.searchQuery = ''; // 清除搜索内容
                    this.showSearch = false; // 关闭搜索框
                },
                // 添加新方法
                async openInPhotoshop() {
                    try {
                        // 获取当前显示的图片路径
                        let imagePath;
                        if (this.selectedHistoryImage) {
                            imagePath = this.selectedHistoryImage;
                        } else if (this.outputImage) {
                            imagePath = this.outputImage;
                        } else {
                            this.$message.warning('没有可用的图片');
                            return;
                        }

                        // 调用后端API
                        const response = await axios.post('/api/open-in-photoshop', {
                            imagePath: imagePath
                        });

                        if (response.data.success) {
                            this.$message.success('已经发送到Photoshop');
                        } else {
                            this.$message.error('发送到Photoshop失败');
                        }
                    } catch (error) {
                        console.error('发送到Photoshop图片失败:', error);
                        this.$message.error(error.response?.data?.error || '发送图片失败');
                    }
                },
                // 添加拖拽相关方法
                handleWorkflowDragStart(event, workflow) {
                    this.draggedWorkflow = workflow;
                    event.target.classList.add('dragging');
                },

                handleWorkflowDragEnd(event) {
                    event.target.classList.remove('dragging');
                    this.draggedWorkflow = null;
                },

                handleWorkflowDrop(event, targetWorkflow) {
                    event.preventDefault();
                    if (!this.draggedWorkflow || this.draggedWorkflow === targetWorkflow) return;

                    const newOrder = [...this.workflowOrder];
                    const draggedIndex = newOrder.indexOf(this.draggedWorkflow.path);
                    const targetIndex = newOrder.indexOf(targetWorkflow.path);

                    if (draggedIndex !== -1) {
                        newOrder.splice(draggedIndex, 1);
                    }
                    if (targetIndex !== -1) {
                        newOrder.splice(targetIndex, 0, this.draggedWorkflow.path);
                    } else {
                        newOrder.push(this.draggedWorkflow.path);
                    }

                    this.workflowOrder = newOrder;
                    this.saveWorkflowOrder();
                },

                // 保存工作流顺序
                async saveWorkflowOrder() {
                    try {
                        await axios.post('/api/workflow-order', {
                            order: this.workflowOrder
                        });
                    } catch (error) {
                        console.error('保存工作流顺序失败:', error);
                    }
                },

                // 加载工作流顺序
                async loadWorkflowOrder() {
                    try {
                        const response = await axios.get('/api/workflow-order');
                        this.workflowOrder = response.data.order || [];
                    } catch (error) {
                        console.error('加载工作流顺序失败:', error);
                    }
                },

                selectWorkflow(workflow) {
                    this.currentWorkflow = workflow.path;
                    this.currentWorkflowName = workflow.name;  // 添加这行来更新显示的工作流名称
                    this.showWorkflowDialog = false;
                    this.loadWorkflow();  // 添加这行来加载选中的工作流
                },
            },
            mounted() {
                this.loadWorkflowList().then(() => {
                    this.loadWorkflow();
                });
                this.connectWebSocket();
                // 初始加载最新图片
                this.loadLatestImage();
                
                // 定期检查新图片
                setInterval(() => {
                    if (!this.ws || this.ws.readyState !== WebSocket.OPEN) {
                        this.loadLatestImage();
                    }
                }, 5000);
                
                this.loadSavedImages();
                
                // 定期刷保存图片列表
                setInterval(() => {
                    this.loadSavedImages();
                }, 5000);
                
                // 初始化参数顺序
                this.$watch('displayedParams', (params) => {
                    if (params.length > 0 && (!this.paramOrder || this.paramOrder.length === 0)) {
                        this.paramOrder = params.map(p => p.id);
                    }
                }, { immediate: true });
                
                this.loadSettings();
                this.loadModelLists();
                this.loadPreprocessors();
                
                // 创建事件处理函数的引用
                this.handleKeyPress = (e) => {
                    if (e.key === 'F5') {
                        e.preventDefault();
                        // F5 模式切换
                        if (this.splitScreenMode) {
                            // 如果在分屏模式，切换到F5模式
                            this.splitScreenMode = false;
                            this.showSidePanels = false;
                        } else if (!this.showSidePanels) {
                            // 如果在F5模式，返回原始模式
                            this.showSidePanels = true;
                        } else {
                            // 如果在原始模式，进入F5模式
                            this.showSidePanels = false;
                        }
                        // 强制重新计算布局
                        this.$nextTick(() => {
                            window.dispatchEvent(new Event('resize'));
                        });
                    }
                    else if (e.key === 'F6') {
                        e.preventDefault();
                        // 简化 F6 模式切换逻辑
                        if (this.splitScreenMode) {
                            // 从分屏模式切换回正常模式
                            this.splitScreenMode = false;
                            this.showSidePanels = true;
                        } else {
                            // 切换到分屏模式
                            this.splitScreenMode = true;
                            this.showSidePanels = false;
                        }

                        // 强制重新计算布局
                        this.$nextTick(() => {
                            window.dispatchEvent(new Event('resize'));
                        });
                    }
                };
                
                // 添加事件监听器
                window.addEventListener('keydown', this.handleKeyPress);

                // 在组件加载时立即检查设置
                this.loadSettings().then(() => {
                    if (!this.comfyuiPath) {
                        this.$message({
                            message: '请先设置 ComfyUI 路径',
                            type: 'warning',
                            duration: 0
                        });
                    }
                });
            },
            beforeUnmount() {
                if (this.ws) {
                    this.ws.close();
                }
                
                // 正确移除事件监听器
                window.removeEventListener('keydown', this.handleKeyPress);
            },
            watch: {
                showSearch(val) {
                    if (val) {
                        // 当搜索框显示时，自动聚焦输入框
                        this.$nextTick(() => {
                            this.$refs.searchInput?.focus();
                        });
                    }
                }
            }
        });

        // 然后注册滑块组件
        app.component('param-slider', {
            props: {
                modelValue: {
                    type: [Number, String],
                    required: true
                },
                label: {
                    type: String,
                    required: true
                },
                min: {
                    type: Number,
                    default: 0
                },
                max: {
                    type: Number,
                    default: 100
                },
                step: {
                    type: Number,
                    default: 1
                }
            },
            template: `
                <div class="param-slider-container">
                    <div class="slider-header">
                        <span class="slider-label">{{ label }}</span>
                        <span class="slider-value">{{ modelValue }}</span>
                    </div>
                    <el-slider
                        :model-value="Number(modelValue)"
                        @update:model-value="$emit('update:modelValue', $event)"
                        :min="min"
                        :max="max"
                        :step="step"
                        @change="$emit('change', $event)"
                        :show-input="false"
                        class="custom-slider"
                    />
                </div>
            `
        });

        // 使用 Element Plus
        app.use(ElementPlus);

        // 添加全局样式
        const style = document.createElement('style');
        style.textContent = `
            .el-message {
                background-color: #409EFF !important;
                border-color: #409EFF !important;
                padding: 15px 20px !important;
            }
            
            .el-message--info {
                background-color: #409EFF !important;
                border-color: #409EFF !important;
            }
            
            .el-message--error {
                background-color: #F56C6C !important;
                border-color: #F56C6C !important;
            }
            
            .el-message__content {
                color: white !important;
                font-size: 14px !important;
            }
            
            .el-message .el-message__icon {
                color: white !important;
                font-size: 16px !important;
            }
            
            .el-message .el-message__closeBtn {
                color: white !important;
            }
        `;
        document.head.appendChild(style);

        // 最后挂载应用
        app.mount('#app');
    </script>
</body>
</html> 